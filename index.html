<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>SJR MUN Registration</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="handler/styles.css" />
  <!-- AOS (Animate On Scroll) for subtle motion -->
  <link rel="stylesheet" href="https://unpkg.com/aos@2.3.4/dist/aos.css" />
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <style>
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(20px);opacity:0;pointer-events:none;background:#0b1220;border:1px solid #1f2937;color:#e5e7eb;border-radius:12px;padding:12px 14px;box-shadow:0 20px 50px rgba(0,0,0,.5);display:flex;align-items:center;gap:12px;min-width:260px;z-index:1000;transition:.25s opacity,.25s transform}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0);pointer-events:auto}
    .toast.success{border-color:rgba(158,240,26,.5)}
    .toast.error{border-color:#7f1d1d}
    .toast.warning{border-color:rgba(245,158,11,.5)}
    .field.error input, .field.error select, .field.field-inline.error { border-color: #ef4444 !important; box-shadow: 0 0 0 2px rgba(239,68,68,0.2) !important; }
    .error-message { color: #ef4444; font-size: 12px; margin-top: 4px; display: none; }
    .field.error .error-message { display: block; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }

    /* Full-bleed banner */
    .banner-wrap{position:relative;left:50%;right:50%;margin-left:-50vw;margin-right:-50vw;width:100vw}
    .banner-wrap img{width:100%;height:auto;display:block}
    
    /* Custom styles for multiple select */
    .department-checkboxes {
      display: grid;
      gap: 10px;
      margin-top: 8px;
      max-height: 240px;
      overflow-y: auto;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--bg-lighter);
      position: relative;
    }
    
    /* Responsive grid layout */
    @media (min-width: 768px) {
      .department-checkboxes {
        grid-template-columns: repeat(2, 1fr);
        max-height: 240px;
      }
    }
    
    @media (min-width: 1024px) {
      .department-checkboxes {
        grid-template-columns: repeat(3, 1fr);
        max-height: 240px;
      }
    }
    
    @media (max-width: 767px) {
      .department-checkboxes {
        grid-template-columns: 1fr;
        max-height: 240px;
      }
    }
    
    /* iOS-style transparent scrollbar */
    .department-checkboxes::-webkit-scrollbar {
      width: 7px;
      height: 7px;
    }
    
    .department-checkboxes::-webkit-scrollbar-track {
      background: transparent;
      border-radius: 10px;
      margin: 4px 0;
    }
    
    .department-checkboxes::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 10px;
      border: 2px solid transparent;
      background-clip: content-box;
      transition: background 0.3s ease;
    }
    
    .department-checkboxes::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.4);
      border: 2px solid transparent;
      background-clip: content-box;
    }
    
    .department-checkboxes::-webkit-scrollbar-corner {
      background: transparent;
    }
    
    /* Firefox scrollbar styling */
    .department-checkboxes {
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
    }
    
    .department-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      transition: all 0.2s ease;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid transparent;
      min-height: 44px;
      box-sizing: border-box;
    }
    
    .department-checkbox:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.1);
      transform: translateY(-1px);
    }
    
    .department-checkbox:active {
      transform: translateY(0);
    }
    
    .department-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      border-radius: 4px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      background: transparent;
      appearance: none;
      -webkit-appearance: none;
      transition: all 0.2s ease;
      position: relative;
      flex-shrink: 0;
    }
    
    .department-checkbox input[type="checkbox"]:checked {
      background: var(--primary);
      border-color: var(--primary);
    }
    
    .department-checkbox input[type="checkbox"]:checked::after {
      content: 'âœ“';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 12px;
      font-weight: bold;
    }
    
    .department-checkbox input[type="checkbox"]:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(158, 240, 26, 0.3);
    }
    
    .department-checkbox span {
      font-size: 14px;
      line-height: 1.4;
      cursor: pointer;
      color: var(--text);
      flex: 1;
      word-break: break-word;
    }
    
    .selection-info {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
      display: block;
      opacity: 0.8;
    }
    
    .department-checkbox.disabled {
      opacity: 0.4;
      cursor: not-allowed;
      pointer-events: none;
    }
    
    .department-checkbox.disabled:hover {
      background: rgba(255, 255, 255, 0.03);
      border-color: transparent;
      transform: none;
    }
    
    /* Selection counter */
    .selection-counter {
      position: absolute;
      top: -28px;
      right: 0;
      font-size: 11px;
      color: var(--text-secondary);
      background: rgba(255, 255, 255, 0.05);
      padding: 4px 10px;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 3;
    }
    
    /* Fade effect at top and bottom for iOS-like scrolling */
    .department-checkboxes::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 20px;
      background: linear-gradient(to bottom, var(--bg-lighter) 0%, transparent 100%);
      pointer-events: none;
      z-index: 2;
      border-radius: 12px 12px 0 0;
    }
    
    .department-checkboxes::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 20px;
      background: linear-gradient(to top, var(--bg-lighter) 0%, transparent 100%);
      pointer-events: none;
      z-index: 2;
      border-radius: 0 0 12px 12px;
    }
    
    /* Make sure content is above the fade effect */
    .department-checkboxes > * {
      position: relative;
      z-index: 1;
    }
    
    /* Department field specific styling */
    .field[data-field-type="departments"] {
      position: relative;
    }
    
    /* Ensure proper spacing in the form grid */
    .field[data-field-type="departments"] {
      grid-column: span 2;
    }
    
    @media (max-width: 767px) {
      .field[data-field-type="departments"] {
        grid-column: span 1;
      }
    }
    
    /* Adjust for existing form grid layout */
    .form-wrap .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    
    @media (max-width: 767px) {
      .form-wrap .grid {
        grid-template-columns: 1fr;
      }
    }
    
    .form-wrap .grid .span-2 {
      grid-column: span 2;
    }
    
    @media (max-width: 767px) {
      .form-wrap .grid .span-2 {
        grid-column: span 1;
      }
    }
    
    /* Loading spinner */
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <main class="page">
    <!-- Full-bleed Banner -->
    <section class="scroll-section" id="hero" data-aos="fade-up" data-aos-delay="60">
      <div class="banner-wrap" aria-label="Hero banner">
        <picture>
          <source media="(max-width: 640px)" srcset="images/banner.gif" />
          <img src="images/banner.png" alt="SJR MUN Banner" />
        </picture>
      </div>
    </section>

    <header class="hero" data-aos="fade-down">
      <h1 class="title glow-title" data-aos="zoom-in">SJR MUN REGISTRATION FORM</h1>
    </header>

    <section class="form-wrap" data-aos="fade-up" data-aos-delay="120">
      <h2 class="section-title">CANDIDATE DETAILS</h2>
      <form id="registrationForm" class="form" novalidate>
        <div class="grid">
          <label class="field">
            <span>Full Name</span>
            <input type="text" name="full_name" placeholder="Full Name" autocomplete="name" required />
            <div class="error-message">Please enter your full name</div>
          </label>

          <label class="field">
            <span>Father's Name</span>
            <input type="text" name="father_name" placeholder="Father's Name" autocomplete="additional-name" required />
            <div class="error-message">Please enter your father's name</div>
          </label>

          <label class="field">
            <span>Mother's Name</span>
            <input type="text" name="mother_name" placeholder="Mother's Name" autocomplete="additional-name" required />
            <div class="error-message">Please enter your mother's name</div>
          </label>

          <fieldset class="field field-inline" id="genderField">
            <legend>Gender</legend>
            <label class="radio"><input type="radio" name="gender" value="Male" required /> <span>Male</span></label>
            <label class="radio"><input type="radio" name="gender" value="Female" required /> <span>Female</span></label>
            <label class="radio"><input type="radio" name="gender" value="Other" required /> <span>Other</span></label>
            <div class="error-message">Please select your gender</div>
          </fieldset>

          <label class="field">
            <span>Date of Birth</span>
            <input type="date" name="dob" autocomplete="bday" required />
            <div class="error-message">Please select your date of birth</div>
          </label>

          <label class="field span-2">
            <span>Institution / School / College name</span>
            <input type="text" name="institute" placeholder="Institution / School / College" autocomplete="organization" required />
            <div class="error-message">Please enter your institution name</div>
          </label>

          <label class="field">
            <span>Class</span>
            <select name="class" autocomplete="education-level" required>
              <option value="" selected disabled>Select</option>
              <option>6</option>
              <option>7</option>
              <option>8</option>
              <option>9</option>
              <option>10</option>
              <option>11</option>
              <option>12</option>
            </select>
            <div class="error-message">Please select your class</div>
          </label>

          <label class="field">
            <span>Phone No.</span>
            <input type="tel" name="phone" inputmode="numeric" placeholder="Enter your phone No" autocomplete="tel" required pattern="[0-9]{10}" />
            <div class="error-message">Please enter a valid 10-digit phone number</div>
          </label>

          <label class="field">
            <span>Email</span>
            <input type="email" name="email" placeholder="Enter your Email" autocomplete="email" required />
            <div class="error-message">Please enter a valid email address</div>
          </label>

          <label class="field span-2">
            <span>Address</span>
            <input type="text" name="address" placeholder="Address" autocomplete="street-address" />
          </label>

          <label class="field">
            <span>Landmark</span>
            <input type="text" name="landmark" placeholder="Landmark" autocomplete="landmark" />
          </label>

          <label class="field">
            <span>City</span>
            <input type="text" name="city" placeholder="City" autocomplete="address-level2" />
          </label>

          <label class="field span-2" data-field-type="departments">
            <span>Department <span class="selection-info">(Select up to 2 departments)</span></span>
            <div class="department-checkboxes" id="departmentCheckboxes">
              <!-- Checkboxes will be generated by JavaScript -->
            </div>
            <input type="hidden" name="department" id="departmentInput" required />
            <div class="error-message">Please select at least one department (max 2)</div>
          </label>
        </div>

        <p class="slogan">"TOGETHER - STRONGER - HIGHER"</p>
        <div class="actions">
          <button type="reset" class="btn ghost" id="resetBtn">Reset</button>
          <button type="submit" class="btn primary" id="submitBtn">Submit</button>
        </div>
      </form>
      <p class="issued">Issued by :SJR MUN CLUB</p>
    </section>

    <footer class="footer">
      <small>Designed for SJR MUN CLUB</small>
      <br />
      <span class="footer-credits">Website by <strong><a class="credit-link" href="https://works.onpratiks.com" target="_blank" rel="noopener noreferrer">Pratik</a></strong> &copy; <span id="currentYear"></span></span>
      <div class="footer-bar">
        <div class="left">
          <a class="social-btn" href="https://www.instagram.com/sjrmun" target="_blank" rel="noopener noreferrer" aria-label="Instagram">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
              <path fill="currentColor" d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm0 2a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H7zm5 3.5a5.5 5.5 0 1 1 0 11 5.5 5.5 0 0 1 0-11zm0 2a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7zm5.75-.75a1.25 1.25 0 1 1-2.5 0 1.25 1.25 0 0 1 2.5 0z"/>
            </svg>
            <span>Instagram</span>
          </a>
        </div>
        <div class="right" style="display:flex; gap:12px; align-items:center;">
          <a class="social-btn admin" href="formview" aria-label="Form View" style="background:transparent; border:1px solid var(--primary); color:var(--primary); box-shadow:none;">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
              <path fill="currentColor" d="M6 2h7l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm7 1.5V8h4.5L13 3.5zM8 11h8v1.5H8V11zm0 3h8v1.5H8V14zm0 3h5v1.5H8V17z"/>
            </svg>
            <span>Form View</span>
          </a>
          <a class="social-btn admin" href="admin" aria-label="Admin Panel">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
              <path fill="currentColor" d="M12 8.5a3.5 3.5 0 1 1 0 7 3.5 3.5 0 0 1 0-7zm9 3.5c0-.5-.04-.98-.12-1.45l2.02-1.57-2-3.46-2.44 1a8.9 8.9 0 0 0-2.51-1.45l-.37-2.6H10.4l-.37 2.6c-.9.3-1.74.75-2.51 1.45l-2.44-1-2 3.46 2.02 1.57c-.08.47-.12.95-.12 1.45s.04.98.12 1.45L1.08 15l2 3.46 2.44-1c.77.7 1.61 1.15 2.51 1.45l.37 2.6h3.68l.37-2.6c.9-.3 1.74-.75 2.51-1.45l2.44 1 2-3.46-2.02-1.57c.08-.47.12-.95.12-1.45z"/>
            </svg>
            <span>Admin Panel</span>
          </a>
        </div>
      </div>
    </footer>
  </main>

  <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
  <script>AOS.init({ once:true, duration:700, easing:'ease-out-cubic' });</script>
  <script src="handler/script.js"></script>
  
  <!-- Form Validation & Toast functionality -->
  <script>
    // Function to format name fields with proper capitalization
    function formatNameField(input) {
      if (!input || !input.value) return;
      
      let value = input.value.trim();
      
      // Split by spaces and capitalize each word
      value = value.split(/\s+/)
        .map(word => {
          // Handle empty words
          if (!word) return '';
          
          // Capitalize first letter, lowercase the rest
          return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
        })
        .join(' ');
      
      // Update the input value
      input.value = value;
    }

    // Function to format institution/school/college names
    function formatInstituteName(input) {
      if (!input || !input.value) return;
      
      let value = input.value.trim();
      
      // Handle common abbreviations and special cases
      const specialWords = {
        'and': 'and',
        'of': 'of',
        'the': 'the',
        'in': 'in',
        'for': 'for',
        'at': 'at',
        'by': 'by',
        'with': 'with',
        'on': 'on',
        'to': 'to',
        'a': 'a',
        'an': 'an',
        'or': 'or',
        '&': '&'
      };
      
      // Split by spaces and format each word
      value = value.split(/\s+/)
        .map((word, index) => {
          // Handle empty words
          if (!word) return '';
          
          // Check if it's a special word (not first word)
          const lowerWord = word.toLowerCase();
          if (index > 0 && specialWords[lowerWord]) {
            return specialWords[lowerWord];
          }
          
          // Handle acronyms (words that are all caps or contain dots)
          if (word === word.toUpperCase() || word.includes('.')) {
            return word;
          }
          
          // Capitalize first letter, lowercase the rest
          return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
        })
        .join(' ');
      
      // Update the input value
      input.value = value;
    }

    // Department management functions
    function initializeDepartmentCheckboxes() {
      const departments = [
        'Delegates Affairs',
        'Logistics',
        'Hospitality',
        'Sponsorship',
        'Outreach',
        'Social Media',
        'Designing',
        'Researcher',
        'Academia Ambassador',
        'Organising Team',
        'Editor',
        'Tech Department',
        'Graphic Designer',
        'Marketing Team'
      ];
      
      const container = document.getElementById('departmentCheckboxes');
      const hiddenInput = document.getElementById('departmentInput');
      const field = hiddenInput.closest('.field');
      
      // Clear container
      container.innerHTML = '';
      
      // Create checkbox for each department
      departments.forEach(dept => {
        const label = document.createElement('label');
        label.className = 'department-checkbox';
        label.innerHTML = `
          <input type="checkbox" value="${dept}" />
          <span>${dept}</span>
        `;
        
        container.appendChild(label);
      });
      
      // Add selection counter element
      const counter = document.createElement('div');
      counter.className = 'selection-counter';
      counter.id = 'selectionCounter';
      counter.style.opacity = '0';
      field.appendChild(counter);
      
      // Add event listeners to checkboxes
      const checkboxes = container.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          updateDepartmentSelection();
        });
        
        // Add focus styles
        checkbox.addEventListener('focus', function() {
          this.closest('.department-checkbox').style.boxShadow = '0 0 0 2px rgba(158, 240, 26, 0.3)';
        });
        
        checkbox.addEventListener('blur', function() {
          this.closest('.department-checkbox').style.boxShadow = 'none';
        });
      });
      
      // Function to update selection and hidden input
      function updateDepartmentSelection() {
        const selected = Array.from(checkboxes)
          .filter(cb => cb.checked)
          .map(cb => cb.value);
        
        // Update hidden input value (comma-separated)
        hiddenInput.value = selected.join(', ');
        
        // Update selection counter
        const counter = document.getElementById('selectionCounter');
        if (selected.length > 0) {
          counter.textContent = `${selected.length}/2 selected`;
          counter.style.opacity = '1';
        } else {
          counter.style.opacity = '0';
        }
        
        // Disable other checkboxes if 2 are selected
        if (selected.length >= 2) {
          checkboxes.forEach(cb => {
            const label = cb.closest('.department-checkbox');
            if (!cb.checked) {
              label.classList.add('disabled');
              cb.disabled = true;
            } else {
              label.classList.remove('disabled');
              cb.disabled = false;
            }
          });
        } else {
          // Enable all checkboxes
          checkboxes.forEach(cb => {
            const label = cb.closest('.department-checkbox');
            label.classList.remove('disabled');
            cb.disabled = false;
          });
        }
        
        // Update validation
        validateDepartmentField();
      }
      
      // Initialize validation
      updateDepartmentSelection();
    }
    
    function validateDepartmentField() {
      const hiddenInput = document.getElementById('departmentInput');
      const field = hiddenInput.closest('.field');
      const errorMessage = field.querySelector('.error-message');
      
      if (!hiddenInput.value.trim()) {
        field.classList.add('error');
        errorMessage.textContent = 'Please select at least one department (max 2)';
      } else {
        field.classList.remove('error');
      }
    }

    // Form validation utility
    (function(){
      function ensureToast(){
        let el = document.getElementById('popup');
        if (!el) {
          el = document.createElement('div');
          el.id = 'popup';
          el.className = 'toast';
          el.innerHTML = '<span id="popupText"></span><button id="popupClose" class="btn ghost">Close</button>';
          document.body.appendChild(el);
          const close = el.querySelector('#popupClose');
          close.addEventListener('click', () => { el.classList.remove('show','success','error','warning'); });
        }
        return el;
      }
      
      window.showToast = function(msg, kind='success'){
        const el = ensureToast();
        const text = el.querySelector('#popupText');
        if (text) text.textContent = msg;
        el.classList.remove('success','error','warning');
        el.classList.add('show', kind);
        clearTimeout(el.__hideT);
        el.__hideT = setTimeout(() => el.classList.remove('show','success','error','warning'), 6000);
      };
      
      window.showSiteError = function(msg){
        window.showToast(msg || 'An error occurred', 'error');
      };
      
      window.showWarning = function(msg){
        window.showToast(msg, 'warning');
      };

      // Form validation functions
      window.validateForm = function(form) {
        let isValid = true;
        const fields = form.querySelectorAll('input[required], select[required], fieldset[required]');
        
        // Clear previous errors
        form.querySelectorAll('.field').forEach(field => {
          field.classList.remove('error');
        });
        
        // Validate each field
        fields.forEach(field => {
          if (field.tagName === 'FIELDSET') {
            // Radio button group validation
            const radios = field.querySelectorAll('input[type="radio"]');
            const checked = Array.from(radios).some(radio => radio.checked);
            if (!checked) {
              field.classList.add('error');
              isValid = false;
            }
          } else if (field.type === 'email') {
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!field.value || !emailRegex.test(field.value)) {
              field.closest('.field').classList.add('error');
              isValid = false;
            }
          } else if (field.type === 'tel') {
            // Phone validation
            const phoneRegex = /^[0-9]{10}$/;
            if (!field.value || !phoneRegex.test(field.value)) {
              field.closest('.field').classList.add('error');
              isValid = false;
            }
          } else if (field.type === 'date') {
            // Date validation
            if (!field.value) {
              field.closest('.field').classList.add('error');
              isValid = false;
            }
          } else if (field.tagName === 'SELECT') {
            // Select validation
            if (!field.value) {
              field.closest('.field').classList.add('error');
              isValid = false;
            }
          } else if (field.id === 'departmentInput') {
            // Department validation (custom)
            if (!field.value.trim()) {
              field.closest('.field').classList.add('error');
              isValid = false;
            }
          } else {
            // Text input validation
            if (!field.value.trim()) {
              field.closest('.field').classList.add('error');
              isValid = false;
            }
          }
        });
        
        return isValid;
      };

      // Real-time validation
      window.setupRealTimeValidation = function(form) {
        const fields = form.querySelectorAll('input, select');
        
        fields.forEach(field => {
          field.addEventListener('blur', () => {
            if (field.hasAttribute('required')) {
              validateField(field);
            }
            
            // Auto-format name fields on blur
            if (field.name === 'full_name' || field.name === 'father_name' || field.name === 'mother_name') {
              formatNameField(field);
            }
            
            // Auto-format institute name on blur
            if (field.name === 'institute') {
              formatInstituteName(field);
            }
          });
          
          field.addEventListener('input', () => {
            if (field.hasAttribute('required') && field.classList.contains('error')) {
              validateField(field);
            }
          });
        });

        // Radio button validation
        const radioGroups = form.querySelectorAll('fieldset[required]');
        radioGroups.forEach(group => {
          const radios = group.querySelectorAll('input[type="radio"]');
          radios.forEach(radio => {
            radio.addEventListener('change', () => {
              if (group.classList.contains('error')) {
                group.classList.remove('error');
              }
            });
          });
        });
        
        // Initialize department checkboxes
        initializeDepartmentCheckboxes();
      };

      function validateField(field) {
        const fieldWrapper = field.closest('.field') || field;
        
        if (field.tagName === 'FIELDSET') {
          const radios = field.querySelectorAll('input[type="radio"]');
          const checked = Array.from(radios).some(radio => radio.checked);
          if (checked) {
            field.classList.remove('error');
          }
        } else if (field.type === 'email') {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (field.value && emailRegex.test(field.value)) {
            fieldWrapper.classList.remove('error');
          }
        } else if (field.type === 'tel') {
          const phoneRegex = /^[0-9]{10}$/;
          if (field.value && phoneRegex.test(field.value)) {
            fieldWrapper.classList.remove('error');
          }
        } else if (field.value && field.value.trim()) {
          fieldWrapper.classList.remove('error');
        }
      }
    })();
  </script>

  <!-- Firebase config loader -->
  <script>
    window.loadFirebaseConfig = async function loadFirebaseConfig(){
      try {
        if (window.FIREBASE_API_KEY && window.FIREBASE_PROJECT_ID) {
          console.log('Firebase config already loaded');
          return true;
        }
        console.log('Loading Firebase config from /api/env...');
        const res = await fetch('/api/env');
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${await res.text()}`);
        }
        const cfg = await res.json();
        console.log('Received config from API:', cfg);
        if (!cfg.FIREBASE_API_KEY || !cfg.FIREBASE_PROJECT_ID) {
          throw new Error('Missing required Firebase configuration from API');
        }
        window.FIREBASE_API_KEY = cfg.FIREBASE_API_KEY;
        window.FIREBASE_AUTH_DOMAIN = cfg.FIREBASE_AUTH_DOMAIN;
        window.FIREBASE_PROJECT_ID = cfg.FIREBASE_PROJECT_ID;
        window.FIREBASE_STORAGE_BUCKET = cfg.FIREBASE_STORAGE_BUCKET;
        window.FIREBASE_MESSAGING_SENDER_ID = cfg.FIREBASE_MESSAGING_SENDER_ID;
        window.FIREBASE_APP_ID = cfg.FIREBASE_APP_ID;
        console.log('Firebase config loaded successfully');
        return true;
      } catch (err) {
        console.error('Failed to load Firebase config:', err);
        window.showSiteError('Application configuration error: ' + (err && err.message ? err.message : 'Failed to fetch'));
        return false;
      }
    }
  </script>

  <!-- Firebase environment setup -->
  <script>
    window.env = {
      FIREBASE_API_KEY: window.FIREBASE_API_KEY || "",
      FIREBASE_AUTH_DOMAIN: window.FIREBASE_AUTH_DOMAIN || "",
      FIREBASE_PROJECT_ID: window.FIREBASE_PROJECT_ID || "",
      FIREBASE_STORAGE_BUCKET: window.FIREBASE_STORAGE_BUCKET || "",
      FIREBASE_MESSAGING_SENDER_ID: window.FIREBASE_MESSAGING_SENDER_ID || "",
      FIREBASE_APP_ID: window.FIREBASE_APP_ID || ""
    };
  </script>

  <!-- Current year for footer -->
  <script>
    document.getElementById('currentYear').textContent = new Date().getFullYear();
  </script>

  <!-- Main Firebase application - USING FIRESTORE LITE (NO EVAL) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, serverTimestamp, increment, query, where, getDocs, collection } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore-lite.js";

    (async () => {
      try {
        const ok = await window.loadFirebaseConfig();
        if (!ok) throw new Error('Firebase configuration failed to load');

        const cfg = {
          apiKey: window.FIREBASE_API_KEY,
          authDomain: window.FIREBASE_AUTH_DOMAIN,
          projectId: window.FIREBASE_PROJECT_ID,
          storageBucket: window.FIREBASE_STORAGE_BUCKET,
          messagingSenderId: window.FIREBASE_MESSAGING_SENDER_ID,
          appId: window.FIREBASE_APP_ID,
        };

        if (!cfg.apiKey || !cfg.projectId) {
          const error = 'Missing Firebase config. Check Vercel environment variables.';
          console.error(error);
          window.showSiteError(error);
          throw new Error(error);
        }

        let app, db;
        try {
          app = initializeApp(cfg);
          db = getFirestore(app);
          console.log('Firestore Lite initialized successfully');
        } catch (error) {
          console.error('Firebase initialization error:', error);
          window.showSiteError('Firebase initialization failed: ' + (error && error.message ? error.message : 'Unknown error'));
          throw error;
        }

        const form = document.getElementById('registrationForm');
        const submitBtn = document.getElementById('submitBtn');
        const resetBtn = document.getElementById('resetBtn');
        
        // Setup real-time validation
        window.setupRealTimeValidation(form);

        const toast = (() => {
          let el = document.getElementById('popup');
          if (!el) {
            el = document.createElement('div');
            el.id = 'popup';
            el.className = 'toast';
            el.innerHTML = '<span id="popupText"></span><button id="popupClose" class="btn ghost">Close</button>';
            document.body.appendChild(el);
          }
          const text = el.querySelector('#popupText');
          const close = el.querySelector('#popupClose');
          let hideT;
          close.addEventListener('click', () => { el.classList.remove('show','success','error','warning'); });
          return {
            show(msg, kind='success'){
              if (text) text.textContent = msg;
              el.classList.remove('success','error','warning');
              el.classList.add('show', kind);
              clearTimeout(hideT);
              hideT = setTimeout(() => el.classList.remove('show','success','error','warning'), 6000);
            }
          };
        })();

        // Function to check if email or phone already exists
        async function checkDuplicateContact(email, phone) {
          try {
            console.log('Checking for duplicate contact:', { email, phone });
            
            // Query for existing email
            const emailQuery = query(collection(db, 'records'), where('email', '==', email.toLowerCase().trim()));
            const emailSnapshot = await getDocs(emailQuery);
            
            // Query for existing phone
            const phoneQuery = query(collection(db, 'records'), where('phone', '==', phone.trim()));
            const phoneSnapshot = await getDocs(phoneQuery);
            
            const results = {
              emailExists: !emailSnapshot.empty,
              phoneExists: !phoneSnapshot.empty,
              existingRecords: []
            };
            
            if (results.emailExists) {
              emailSnapshot.forEach(doc => {
                results.existingRecords.push({
                  id: doc.id,
                  ...doc.data()
                });
              });
            }
            
            if (results.phoneExists) {
              phoneSnapshot.forEach(doc => {
                // Avoid duplicates if same record has both matching email and phone
                if (!results.existingRecords.some(record => record.id === doc.id)) {
                  results.existingRecords.push({
                    id: doc.id,
                    ...doc.data()
                  });
                }
              });
            }
            
            console.log('Duplicate check results:', results);
            return results;
            
          } catch (error) {
            console.error('Error checking duplicate contact:', error);
            throw error;
          }
        }

        // Form submission handler
        form?.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          // Auto-format name fields before validation
          const nameFields = ['full_name', 'father_name', 'mother_name'];
          nameFields.forEach(fieldName => {
            const input = form.querySelector(`[name="${fieldName}"]`);
            if (input) {
              formatNameField(input);
            }
          });
          
          // Auto-format institute name before validation
          const instituteInput = form.querySelector('[name="institute"]');
          if (instituteInput) {
            formatInstituteName(instituteInput);
          }
          
          // Validate form before submission
          if (!window.validateForm(form)) {
            window.showToast('Please fill all required fields correctly.', 'error');
            // Scroll to first error
            const firstError = form.querySelector('.error');
            if (firstError) {
              firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
          }

          // Disable submit button to prevent multiple submissions
          submitBtn.disabled = true;
          const originalText = submitBtn.textContent;
          submitBtn.innerHTML = '<span class="loading-spinner"></span> Checking...';

          const fd = new FormData(form);
          const data = Object.fromEntries(fd.entries());

          try {
            console.log('Starting duplicate check...', data);
            
            // Check for duplicate email or phone
            const duplicateCheck = await checkDuplicateContact(data.email, data.phone);
            
            if (duplicateCheck.emailExists || duplicateCheck.phoneExists) {
              let message = '';
              const existingRecord = duplicateCheck.existingRecords[0];
              
              if (duplicateCheck.emailExists && duplicateCheck.phoneExists) {
                message = `This email and phone number are already registered. Form Number: ${existingRecord.form_number}`;
              } else if (duplicateCheck.emailExists) {
                message = `This email is already registered. Form Number: ${existingRecord.form_number}`;
              } else if (duplicateCheck.phoneExists) {
                message = `This phone number is already registered. Form Number: ${existingRecord.form_number}`;
              }
              
              window.showWarning(message + '. If you need to update, please contact admin.');
              submitBtn.disabled = false;
              submitBtn.textContent = originalText;
              return;
            }
            
            console.log('No duplicates found, proceeding with submission...');
            
            // Update button text for submission phase
            submitBtn.innerHTML = '<span class="loading-spinner"></span> Submitting...';
            
            // Firestore Lite: use atomic increment instead of transaction
            const counterRef = doc(db, 'meta', 'counters');
            
            // Ensure counter exists and get current value
            const counterSnap = await getDoc(counterRef);
            let current = 0;
            if (counterSnap.exists()) {
              current = Number(counterSnap.data().formCounter || 0);
            } else {
              // Create counter if it doesn't exist
              await setDoc(counterRef, { formCounter: 0 });
            }
            
            // Atomic increment (no race conditions)
            await updateDoc(counterRef, {
              formCounter: increment(1)
            });
            
            // Get the updated value
            const updatedSnap = await getDoc(counterRef);
            const nextNumber = Number(updatedSnap.data().formCounter);

            const formNumber = String(nextNumber).padStart(6, '0');
            const record = {
              form_number: formNumber,
              full_name: data.full_name || '',
              father_name: data.father_name || '',
              mother_name: data.mother_name || '',
              gender: data.gender || '',
              dob: data.dob || '',
              institute: data.institute || '',
              class: data.class || '',
              phone: data.phone.trim() || '',
              email: data.email.toLowerCase().trim() || '',
              address: data.address || '',
              landmark: data.landmark || '',
              city: data.city || '',
              department: data.department || '',
              created_at: serverTimestamp()
            };

            console.log('Saving record to Firestore:', record);
            await setDoc(doc(db, 'records', formNumber), record);
            console.log('Record saved successfully');

            toast.show(`Registration successful! Your Form Number is ${formNumber}. Save it for future reference.`, 'success');
            form.reset();
            
            // Reset department checkboxes
            const checkboxes = document.querySelectorAll('#departmentCheckboxes input[type="checkbox"]');
            checkboxes.forEach(cb => {
              cb.checked = false;
              cb.disabled = false;
              cb.closest('.department-checkbox').classList.remove('disabled');
            });
            document.getElementById('departmentInput').value = '';
            document.getElementById('selectionCounter').style.opacity = '0';
            
          } catch (err) {
            console.error('Form submission error:', err);
            
            if (err.message && err.message.includes('already exists') || err.message.includes('duplicate')) {
              window.showWarning('This email or phone number is already registered. Please use different contact information.');
            } else {
              toast.show('Could not complete registration. Please try again.', 'error');
            }
          } finally {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });

        // Reset button handler
        resetBtn?.addEventListener('click', () => {
          // Clear all error states
          form.querySelectorAll('.field').forEach(field => {
            field.classList.remove('error');
          });
          
          // Reset department checkboxes
          const checkboxes = document.querySelectorAll('#departmentCheckboxes input[type="checkbox"]');
          checkboxes.forEach(cb => {
            cb.checked = false;
            cb.disabled = false;
            cb.closest('.department-checkbox').classList.remove('disabled');
          });
          document.getElementById('departmentInput').value = '';
          document.getElementById('selectionCounter').style.opacity = '0';
        });

      } catch (error) {
        console.error('Critical error in module:', error);
        window.showSiteError('Application failed to initialize. Please refresh the page.');
      }
    })();
  </script>
</body>
</html>
