<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Login SJR MUN</title>
  <!-- REMOVED CSP - Matching index.html -->
  <link rel="stylesheet" href="../handler/styles.css" />
  <link rel="icon" type="image/x-icon" href="../favicon.ico" />
  <style>
    body { min-height:100vh; background: radial-gradient(1200px 600px at 20% -10%, #7c3aed22, transparent), radial-gradient(1000px 500px at 120% 10%, #06b6d422, transparent), linear-gradient(180deg, #0b1020, #0f172a); color:#e5e7eb; }
    .auth-shell { display:grid; place-items:center; min-height:100vh; padding:24px; }
    .auth-card { width:100%; max-width:440px; background:rgba(17, 24, 39, 0.7); backdrop-filter: blur(8px); border:1px solid #1f2937; border-radius:16px; box-shadow: 0 20px 60px rgba(0,0,0,.45); padding:28px; }
    .brand { display:flex; align-items:center; gap:10px; margin-bottom:16px; }
    .brand .logo { width:64px; height:64px; border-radius:12px; object-fit:cover; background:#fff; box-shadow: 0 10px 28px rgba(158,240,26,.20); }
    .brand h1 { font-size:20px; margin:0; color:#f8fafc; letter-spacing:.3px; }
    .subtitle { color:#9ca3af; margin:0 0 16px 0; font-size:13px; }
    .form .field span { color:#cbd5e1; }
    .form input { background:#0b1220; border:1px solid #1f2937; color:#e5e7eb; border-radius:10px; padding:12px 12px; outline:none; transition:.2s border-color, .2s box-shadow; }
    .form input:focus { border-color:#6366f1; box-shadow:0 0 0 4px #6366f11f; }
    .actions { gap:10px; }
    .btn.primary { background:linear-gradient(135deg, var(--primary, #9ef01a), var(--primary-strong, #b9ff2b)); border:none; box-shadow:0 10px 24px rgba(158,240,26,.18); color:#0b1220; font-weight:600; }
    .btn.ghost { border-color:#334155; color:#cbd5e1; }
    
    /* Toast styles */
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(20px);opacity:0;pointer-events:none;background:#0b1220;border:1px solid #1f2937;color:#e5e7eb;border-radius:12px;padding:12px 14px;box-shadow:0 20px 50px rgba(0,0,0,.5);display:flex;align-items:center;gap:12px;min-width:260px;z-index:1000;transition:.25s opacity,.25s transform}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0);pointer-events:auto}
    .toast.success{border-color:rgba(158,240,26,.5)}
    .toast.error{border-color:#7f1d1d}
    
    /* Loading state */
    .btn:disabled { opacity:0.7; cursor:not-allowed; }
    
    /* Logout message */
    .logout-message { 
      background: rgba(239, 68, 68, 0.1); 
      border: 1px solid rgba(239, 68, 68, 0.3); 
      border-radius: 8px; 
      padding: 12px; 
      margin-bottom: 16px; 
      text-align: center; 
      color: #fca5a5; 
      font-size: 14px; 
      display: none; 
    }
  </style>
</head>
<body>
  <div class="auth-shell">
    <div class="auth-card">
      <!-- Logout Message - Only show if user was manually logged out -->
      <div id="logoutMessage" class="logout-message">
        You have been logged out. Please sign in again to continue.
      </div>
      
      <div class="brand">
        <img class="logo" src="../images/logo.png" alt="SJR MUN" />
        <h1>Admin Access</h1>
      </div>
      <p class="subtitle">Sign in to manage registrations</p>
      
       <!-- Email/Password Form (Primary) -->
      <form id="emailLoginForm" class="form" novalidate>
        <div class="grid">
          <label class="field">
            <span>Email</span>
            <input type="email" id="emailInput" name="email" placeholder="you@example.com" required />
          </label>
          <label class="field">
            <span>Password</span>
            <input type="password" name="password" placeholder="••••••••" required />
          </label>
        </div>
        <div class="actions">
          <button type="submit" class="btn primary" style="flex:1;">Login with Email</button>
          <button type="button" id="resetPasswordBtn" class="btn ghost">Forgot Password</button>
        </div>
      </form>

  <footer class="footer elevated" style="--footer-margin-top:120px; --footer-margin-bottom:80px; --footer-padding-bottom:22px;">
    <small>Designed for SJR MUN CLUB</small>
    <br />
    <span class="footer-credits">Website by <strong><a class="credit-link" href="https://works.onpratiks.com" target="_blank" rel="noopener noreferrer">Pratik</a></strong> &copy; <span id="currentYear"></span></span>
    <div class="footer-bar">
      <div class="left">
        <a class="social-btn" href="https://www.instagram.com/sjrmun" target="_blank" rel="noopener noreferrer" aria-label="Instagram">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
            <path fill="currentColor" d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm0 2a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H7zm5 3.5a5.5 5.5 0 1 1 0 11 5.5 5.5 0 0 1 0-11zm0 2a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7zm5.75-.75a1.25 1.25 0 1 1-2.5 0 1.25 1.25 0 0 1 2.5 0z"/>
          </svg>
          <span>Instagram</span>
        </a>
      </div>
      <div class="right" style="display:flex; gap:12px; align-items:center;">
        <a class="social-btn admin" href="../" aria-label="Home" style="background:transparent; border:1px solid var(--primary); color:var(--primary); box-shadow:none;">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false"><path fill="currentColor" d="M3 9.5 12 3l9 6.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V9.5z"/></svg>
          <span>Home</span>
        </a>
        <a class="social-btn admin" href="../formview" aria-label="Form View">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false"><path fill="currentColor" d="M6 2h7l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm7 1.5V8h4.5L13 3.5zM8 11h8v1.5H8V11zm0 3h8v1.5H8V14zm0 3h5v1.5H8V17z"/></svg>
          <span>Form View</span>
        </a>
      </div>
    </div>
  </footer>

  <script>
    (function(){
      const y = document.getElementById('currentYear');
      if (y) y.textContent = new Date().getFullYear();
      const fc = document.querySelector('.footer-credits');
      if (fc) fc.style.transform = 'translateY(-2px)';
    })();
  </script>
  
  <script>
    // Firebase configuration loader from /api/env
    window.loadFirebaseConfig = async function loadFirebaseConfig() {
      try {
        // Check if we already have the config
        if (window.firebaseConfig && window.firebaseConfig.apiKey) {
          return window.firebaseConfig;
        }

        console.log('[Auth] Loading Firebase config from /api/env...');
        const res = await fetch('/api/env');
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: Failed to load configuration`);
        }
        
        const cfg = await res.json();
        console.log('[Auth] Received config from API:', cfg);
        
        // Validate required Firebase config
        if (!cfg.FIREBASE_API_KEY || !cfg.FIREBASE_PROJECT_ID) {
          throw new Error('Missing required Firebase configuration from API');
        }

        // Construct Firebase config object
        window.firebaseConfig = {
          apiKey: cfg.FIREBASE_API_KEY,
          authDomain: cfg.FIREBASE_AUTH_DOMAIN || `${cfg.FIREBASE_PROJECT_ID}.firebaseapp.com`,
          projectId: cfg.FIREBASE_PROJECT_ID,
          storageBucket: cfg.FIREBASE_STORAGE_BUCKET || `${cfg.FIREBASE_PROJECT_ID}.appspot.com`,
          messagingSenderId: cfg.FIREBASE_MESSAGING_SENDER_ID,
          appId: cfg.FIREBASE_APP_ID
        };

        console.log('[Auth] Firebase config loaded successfully');
        return window.firebaseConfig;
        
      } catch (err) {
        console.error('[Auth] Failed to load Firebase config:', err);
        showToast('Application configuration error. Please contact administrator.', 'error');
        throw err;
      }
    };

    // Toast notification system
    (function(){
      function ensureToast(){
        let el = document.getElementById('popup');
        if (!el) {
          el = document.createElement('div');
          el.id = 'popup';
          el.className = 'toast';
          el.innerHTML = '<span id="popupText"></span><button id="popupClose" class="btn ghost">Close</button>';
          document.body.appendChild(el);
          const close = el.querySelector('#popupClose');
          close.addEventListener('click', () => { el.classList.remove('show','success','error'); });
        }
        return el;
      }
      
      window.showToast = function(msg, kind = 'success') {
        const el = ensureToast();
        const text = el.querySelector('#popupText');
        if (text) text.textContent = msg;
        el.classList.remove('success','error');
        el.classList.add('show', kind);
        clearTimeout(el.__hideT);
        el.__hideT = setTimeout(() => el.classList.remove('show','success','error'), 6000);
      };
    })();
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { 
      getAuth, 
      onAuthStateChanged, 
      signInWithEmailAndPassword, 
      sendPasswordResetEmail,
      setPersistence,
      browserSessionPersistence,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { 
      getFirestore,
      doc,
      getDoc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore-lite.js";

    let auth = null;
    let app = null;
    let db = null;
    let isInitialized = false;

    // Initialize Firebase Auth and Firestore Lite
    async function initializeFirebaseAuth() {
      try {
        // Load Firebase configuration from API
        const firebaseConfig = await window.loadFirebaseConfig();
        
        // Initialize Firebase app
        app = initializeApp(firebaseConfig, 'AdminAuth');
        auth = getAuth(app);
        db = getFirestore(app);
        
        // Set session persistence
        await setPersistence(auth, browserSessionPersistence);
        
        console.log('[Auth] Firebase Auth and Firestore Lite initialized successfully');
        isInitialized = true;
        setupAuthListeners();
        enableLoginButtons();
        
      } catch (error) {
        console.error('[Auth] Failed to initialize Firebase:', error);
        showToast('Failed to initialize authentication system.', 'error');
        // Still enable buttons even if Firebase fails, so user can at least try
        enableLoginButtons();
      }
    }

    // Check if user exists in Firestore
    async function checkUserExists(userId) {
      try {
        if (!db) {
          console.error('[Firestore] Database not initialized');
          return false;
        }

        const userRef = doc(db, 'users', userId);
        const userSnap = await getDoc(userRef);
        
        return userSnap.exists();
      } catch (error) {
        console.error('[Auth] Error checking user existence:', error);
        return false;
      }
    }

    // Create or update user document in Firestore (ONLY for existing users)
    async function updateUserDocument(user) {
      try {
        if (!db) {
          console.error('[Firestore] Database not initialized');
          return;
        }

        const userRef = doc(db, 'users', user.uid);
        const userSnap = await getDoc(userRef);
        
        if (userSnap.exists()) {
          // Update last login time for existing user
          await setDoc(userRef, {
            lastLoginAt: new Date().toISOString(),
            email: user.email,
            displayName: user.displayName || '',
            photoURL: user.photoURL || ''
          }, { merge: true });
          console.log('[Firestore] User document updated:', user.uid);
          return true;
        } else {
          // User doesn't exist in Firestore - don't create new document
          console.log('[Auth] User not found in Firestore, access denied:', user.email);
          return false;
        }
      } catch (error) {
        console.error('[Firestore] Error updating user document:', error);
        return false;
      }
    }

    // Setup authentication state listener
    function setupAuthListeners() {
      if (!auth) return;
      
      onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log('[Auth] User is signed in:', user.email);
          // User is already signed in - redirect them to admin panel immediately
          redirectToAdminPanel();
        } else {
          console.log('[Auth] User is not signed in');
          // User is signed out, ensure buttons are enabled
          enableLoginButtons();
        }
      });
    }

    // Redirect to admin panel
function redirectToAdminPanel() {
  console.log('[Auth] Redirecting to admin panel...');
  // Simple fixed path - always go to panel in the same directory
  window.location.href = 'panel/';
}
    }

    // Enable login buttons
    function enableLoginButtons() {
      const emailBtn = document.querySelector('#emailLoginForm button[type="submit"]');
      const resetBtn = document.getElementById('resetPasswordBtn');
      
      if (emailBtn) {
        emailBtn.disabled = false;
        emailBtn.style.opacity = '1';
        emailBtn.style.cursor = 'pointer';
      }
      if (resetBtn) {
        resetBtn.disabled = false;
        resetBtn.style.opacity = '1';
        resetBtn.style.cursor = 'pointer';
      }
      
      console.log('[Auth] Buttons enabled');
    }

    // Disable login buttons
    function disableLoginButtons() {
      const emailBtn = document.querySelector('#emailLoginForm button[type="submit"]');
      const resetBtn = document.getElementById('resetPasswordBtn');
      
      if (emailBtn) {
        emailBtn.disabled = true;
        emailBtn.style.opacity = '0.7';
        emailBtn.style.cursor = 'not-allowed';
      }
      if (resetBtn) {
        resetBtn.disabled = true;
        resetBtn.style.opacity = '0.7';
        resetBtn.style.cursor = 'not-allowed';
      }
      
      console.log('[Auth] Buttons disabled');
    }

    // Set button loading state
    function setButtonLoading(button, isLoading) {
      if (!button) return;
      
      if (isLoading) {
        button.setAttribute('data-original-text', button.innerHTML);
        button.innerHTML = '<span>Signing in...</span>';
        button.disabled = true;
        button.style.opacity = '0.7';
        button.style.cursor = 'not-allowed';
      } else {
        const originalText = button.getAttribute('data-original-text');
        if (originalText) {
          button.innerHTML = originalText;
        }
        button.disabled = false;
        button.style.opacity = '1';
        button.style.cursor = 'pointer';
      }
    }

    // Email/Password login - checks if user exists in Firestore
    async function handleEmailLogin(email, password) {
      if (!isInitialized || !auth) {
        showToast('Authentication system not ready. Please try again.', 'error');
        return;
      }

      const submitBtn = document.querySelector('#emailLoginForm button[type="submit"]');
      setButtonLoading(submitBtn, true);

      try {
        console.log('[Auth] Attempting email sign-in...');
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        console.log('[Auth] Email sign-in successful, checking user in Firestore:', user.email);
        
        // Check if user exists in Firestore
        const userExists = await checkUserExists(user.uid);
        
        if (!userExists) {
          // User doesn't exist in Firestore - sign them out and show error
          await signOut(auth);
          console.log('[Auth] Access denied - user not registered:', user.email);
          showToast('Access denied. Your account is not registered in the system. Please contact administrator.', 'error');
          setButtonLoading(submitBtn, false);
          return;
        }
        
        // User exists - update their document and allow login
        await updateUserDocument(user);
        
        // Show success message and redirect
        showToast('Login successful! Redirecting...', 'success');
        setTimeout(() => {
          redirectToAdminPanel();
        }, 1000);
        
      } catch (error) {
        console.error('[Auth] Email sign-in error:', error);
        
        let errorMessage = 'Sign-in failed. Please check your credentials.';
        
        switch (error.code) {
          case 'auth/invalid-email':
            errorMessage = 'Invalid email address.';
            break;
          case 'auth/user-disabled':
            errorMessage = 'This account has been disabled.';
            break;
          case 'auth/user-not-found':
            errorMessage = 'No account found with this email.';
            break;
          case 'auth/wrong-password':
            errorMessage = 'Incorrect password.';
            break;
          case 'auth/invalid-credential':
            errorMessage = 'Invalid login credentials.';
            break;
          case 'auth/too-many-requests':
            errorMessage = 'Too many failed attempts. Please try again later.';
            break;
          default:
            errorMessage = `Sign-in failed: ${error.message}`;
        }
        
        showToast(errorMessage, 'error');
        setButtonLoading(submitBtn, false);
      }
    }

    // Password reset
    async function handlePasswordReset(email) {
      if (!isInitialized || !auth) {
        showToast('Authentication system not ready. Please try again.', 'error');
        return;
      }

      const resetBtn = document.getElementById('resetPasswordBtn');
      const originalText = resetBtn.innerHTML;
      resetBtn.innerHTML = 'Sending...';
      resetBtn.disabled = true;
      resetBtn.style.opacity = '0.7';
      resetBtn.style.cursor = 'not-allowed';

      try {
        console.log('[Auth] Sending password reset email...');
        await sendPasswordResetEmail(auth, email);
        
        showToast('Password reset email sent. Check your inbox.', 'success');
        console.log('[Auth] Password reset email sent successfully');
        
      } catch (error) {
        console.error('[Auth] Password reset error:', error);
        
        let errorMessage = 'Failed to send reset email.';
        
        switch (error.code) {
          case 'auth/user-not-found':
            errorMessage = 'No account found with this email.';
            break;
          case 'auth/invalid-email':
            errorMessage = 'Invalid email address.';
            break;
          case 'auth/too-many-requests':
            errorMessage = 'Too many attempts. Please try again later.';
            break;
          default:
            errorMessage = `Reset failed: ${error.message}`;
        }
        
        showToast(errorMessage, 'error');
      } finally {
        resetBtn.innerHTML = originalText;
        resetBtn.disabled = false;
        resetBtn.style.opacity = '1';
        resetBtn.style.cursor = 'pointer';
      }
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('[Auth] Initializing application...');
      
      // Setup event listeners
      document.getElementById('emailLoginForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const email = formData.get('email');
        const password = formData.get('password');
        handleEmailLogin(email, password);
      });
      
      document.getElementById('resetPasswordBtn').addEventListener('click', () => {
        const emailInput = document.getElementById('emailInput');
        const email = emailInput.value.trim();
        
        if (!email) {
          showToast('Please enter your email address first.', 'error');
          emailInput.focus();
          return;
        }
        
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          showToast('Please enter a valid email address.', 'error');
          emailInput.focus();
          return;
        }
        
        handlePasswordReset(email);
      });
      
      // Disable buttons until Firebase is initialized
      disableLoginButtons();
      
      try {
        await initializeFirebaseAuth();
      } catch (error) {
        console.error('[Auth] Application initialization failed:', error);
        showToast('Failed to initialize application.', 'error');
        // Enable buttons anyway so user can try
        enableLoginButtons();
      }
    });
  </script>
</body>
</html>