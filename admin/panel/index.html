<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SJR MUN View / Download Your Form</title>
  <link rel="stylesheet" href="../handler/styles.css" />
  <link rel="icon" type="image/x-icon" href="../favicon.ico" />
  <style>
    body { 
      min-height: 100vh; 
      background: radial-gradient(1200px 600px at 20% -10%, #7c3aed22, transparent), 
                  radial-gradient(1000px 500px at 120% 10%, #06b6d422, transparent), 
                  linear-gradient(180deg, #0b1020, #0f172a); 
      color: #e5e7eb; 
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }
    
    .view-shell { 
      display: grid; 
      place-items: center; 
      min-height: 100vh;
      padding: 24px; 
      box-sizing: border-box;
    }
    
    .view-card { 
      width: 100%; 
      max-width: 920px; 
      background: rgba(17, 24, 39, 0.7); 
      backdrop-filter: blur(8px); 
      border: 1px solid #1f2937; 
      border-radius: 16px; 
      box-shadow: 0 20px 60px rgba(0,0,0,.45); 
      padding: 32px; 
      box-sizing: border-box;
    }
    
    .header { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 12px; 
      margin-bottom: 24px; 
    }
    
    .header .title { 
      margin: 0; 
      font-size: 24px; 
      color: #f8fafc; 
      font-weight: 600;
    }
    
    .form .field span { 
      color: #cbd5e1; 
      font-weight: 500;
      margin-bottom: 8px;
      display: block;
    }
    
    .form input, .form select { 
      background: #0b1220; 
      border: 1px solid #1f2937; 
      color: #e5e7eb; 
      border-radius: 10px; 
      padding: 12px 16px; 
      outline: none; 
      transition: .2s border-color, .2s box-shadow; 
      width: 100%;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    
    .form input:focus, .form select:focus { 
      border-color: #6366f1; 
      box-shadow: 0 0 0 4px #6366f11f; 
    }
    
    .actions { 
      display: flex;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    
    .btn { 
      border-radius: 10px; 
      padding: 12px 24px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 14px;
    }
    
    .btn.primary, .btn { 
      background: linear-gradient(135deg, #9ef01a, #b9ff2b); 
      border: none; 
      color: #0b1220; 
      box-shadow: 0 10px 24px rgba(158,240,26,.18); 
    }
    
    .btn.primary:hover, .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(158,240,26,.25);
    }
    
    .btn.ghost { 
      background: #111827; 
      border: 1px solid #1f2937; 
      color: #cbd5e1; 
    }
    
    .btn.ghost:hover {
      background: #1f2937;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    #matches .field span { 
      color: #cbd5e1; 
    }
    
    .kv { 
      display: grid; 
      grid-template-columns: 180px 1fr; 
      gap: 16px;
      margin-top: 16px;
    }
    
    .kv .k { 
      color: #94a3b8; 
      font-weight: 500;
    }
    
    .hidden { 
      display: none !important; 
    }
    
    #result { 
      margin-top: 24px; 
      padding: 24px; 
      background: #0b1220; 
      border: 1px solid #1f2937; 
      border-radius: 12px; 
    }
    
    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .result-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .toast {
      position: fixed;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%) translateY(20px);
      opacity: 0;
      pointer-events: none;
      background: #0b1220;
      border: 1px solid #1f2937;
      color: #e5e7eb;
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: 0 20px 50px rgba(0,0,0,.5);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 260px;
      z-index: 1000;
      transition: .25s opacity, .25s transform;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
      pointer-events: auto;
    }
    
    .toast.success {
      border-color: rgba(158,240,26,.5);
    }
    
    .toast.error {
      border-color: #7f1d1d;
    }
    
    .field.error input, .field.error select {
      border-color: #ef4444 !important;
      box-shadow: 0 0 0 2px rgba(239,68,68,0.2) !important;
    }
    
    .error-message {
      color: #ef4444;
      font-size: 12px;
      margin-top: 4px;
      display: none;
    }
    
    .field.error .error-message {
      display: block;
    }
    
    .footer {
      margin-top: 80px;
      margin-bottom: 40px;
      padding-bottom: 22px;
      text-align: center;
      color: #94a3b8;
      font-size: 14px;
    }
    
    .footer-credits {
      margin-top: 8px;
      display: block;
    }
    
    .credit-link {
      color: #9ef01a;
      text-decoration: none;
    }
    
    .credit-link:hover {
      text-decoration: underline;
    }
    
    .footer-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .social-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: #cbd5e1;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    .social-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #f8fafc;
    }
    
    .social-btn.admin {
      background: rgba(158, 240, 26, 0.1);
      border-color: rgba(158, 240, 26, 0.3);
      color: #9ef01a;
    }
    
    .social-btn.admin:hover {
      background: rgba(158, 240, 26, 0.2);
    }
    
    .admin-section {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid #1f2937;
    }
    
    .admin-section h3 {
      color: #f8fafc;
      margin-bottom: 16px;
      font-size: 18px;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #9ef01a;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .view-card {
        padding: 24px;
      }
      
      .kv {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      
      .footer-bar {
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }
      
      .footer-bar .left,
      .footer-bar .right {
        justify-content: center;
      }
      
      .result-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .result-actions {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <div class="view-shell">
    <div class="view-card">
      <div class="header">
        <h2 class="title">Find Your Registration</h2>
      </div>
      <form id="lookupForm" class="form" novalidate>
        <div class="grid">
          <label class="field">
            <span>Search By</span>
            <select name="search_by" id="searchBy">
              <option value="form_number" selected>Form Number</option>
              <option value="email">Email</option>
              <option value="phone">Phone</option>
            </select>
          </label>
          <label class="field" id="fieldFormNumber">
            <span>Form Number</span>
            <input type="text" name="form_number" placeholder="e.g. 000123" required />
            <div class="error-message">Please enter a valid form number</div>
          </label>
          <label class="field hidden" id="fieldEmail">
            <span>Email</span>
            <input type="email" name="email" placeholder="you@example.com" />
            <div class="error-message">Please enter a valid email address</div>
          </label>
          <label class="field hidden" id="fieldPhone">
            <span>Phone</span>
            <input type="tel" name="phone" inputmode="numeric" placeholder="10-digit phone" pattern="[0-9]{10}" />
            <div class="error-message">Please enter a valid 10-digit phone number</div>
          </label>
        </div>
        <div class="actions">
          <button type="submit" class="btn primary">Search</button>
        </div>
      </form>

      <div id="matches" class="hidden" style="margin-top: 24px;">
        <label class="field">
          <span>Select Your Form</span>
          <select id="matchSelect"></select>
        </label>
      </div>

      <div id="result" class="hidden">
        <div class="result-header">
          <h3 style="margin: 0; color: #f8fafc;">Form Details</h3>
          <div class="result-actions">
            <button id="downloadPdfBtn" class="btn">Download PDF</button>
          </div>
        </div>
        <div id="kvPanel" class="kv" style="margin-top: 16px;"></div>
      </div>

      <!-- Admin Section for Export All -->
      <div class="admin-section">
        <h3>Admin Functions</h3>
        <div class="actions">
          <button id="exportAllPdfBtn" class="btn ghost">Export All PDFs</button>
          <button id="exportAllDataBtn" class="btn ghost">Export All Data (CSV)</button>
        </div>
        <div id="exportProgress" class="hidden" style="margin-top: 16px;">
          <div style="color: #cbd5e1; margin-bottom: 8px;">Exporting... <span id="progressText">0%</span></div>
          <div style="background: #1f2937; border-radius: 4px; height: 8px; overflow: hidden;">
            <div id="progressBar" style="background: #9ef01a; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <footer class="footer">
    <small>Designed for SJR MUN CLUB</small>
    <br />
    <span class="footer-credits">Website by <strong><a class="credit-link" href="https://works.onpratiks.com" target="_blank" rel="noopener noreferrer">Pratik</a></strong> Â© <span id="currentYear"></span></span>
    <div class="footer-bar">
      <div class="left">
        <a class="social-btn" href="https://www.instagram.com/sjrmun" target="_blank" rel="noopener noreferrer" aria-label="Instagram">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
            <path fill="currentColor" d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm0 2a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H7zm5 3.5a5.5 5.5 0 1 1 0 11 5.5 5.5 0 0 1 0-11zm0 2a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7zm5.75-.75a1.25 1.25 0 1 1-2.5 0 1.25 1.25 0 0 1 2.5 0z"/>
          </svg>
          <span>Instagram</span>
        </a>
      </div>
      <div class="right" style="display: flex; gap: 12px; align-items: center;">
        <a class="social-btn admin" href="../" aria-label="Home" style="background: transparent; border: 1px solid #9ef01a; color: #9ef01a; box-shadow: none;">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
            <path fill="currentColor" d="M3 9.5 12 3l9 6.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V9.5z"/>
          </svg>
          <span>Home</span>
        </a>
        <a class="social-btn admin" href="../admin" aria-label="Admin Panel">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
            <path fill="currentColor" d="M12 8.5a3.5 3.5 0 1 1 0 7 3.5 3.5 0 0 1 0-7zm9 3.5c0-.5-.04-.98-.12-1.45l2.02-1.57-2-3.46-2.44 1a8.9 8.9 0 0 0-2.51-1.45l-.37-2.6H10.4l-.37 2.6c-.9.3-1.74.75-2.51 1.45l-2.44-1-2 3.46 2.02 1.57c-.08.47-.12.95-.12 1.45s.04.98.12 1.45L1.08 15l2 3.46 2.44-1c.77.7 1.61 1.15 2.51 1.45l.37 2.6h3.68l.37-2.6c.9-.3 1.74-.75 2.51-1.45l2.44 1 2-3.46-2.02-1.57c.08-.47.12-.95.12-1.45z"/>
          </svg>
          <span>Admin Panel</span>
        </a>
      </div>
    </div>
  </footer>

  <script>
    (function(){
      const el = document.getElementById('currentYear');
      if (el) el.textContent = new Date().getFullYear();
    })();
  </script>
  
  <script>
    (function(){
      function ensureToast(){
        let el = document.getElementById('popup');
        if (!el) {
          el = document.createElement('div');
          el.id = 'popup';
          el.className = 'toast';
          el.innerHTML = '<span id="popupText"></span><button id="popupClose" class="btn ghost">Close</button>';
          document.body.appendChild(el);
          const close = el.querySelector('#popupClose');
          close.addEventListener('click', () => { el.classList.remove('show','success','error'); });
        }
        return el;
      }
      
      window.showToast = function(msg, kind='success'){
        const el = ensureToast();
        const text = el.querySelector('#popupText');
        if (text) text.textContent = msg;
        el.classList.remove('success','error');
        el.classList.add('show', kind);
        clearTimeout(el.__hideT);
        el.__hideT = setTimeout(() => el.classList.remove('show','success','error'), 6000);
      }
    })();
  </script>
  
  <script>
    window.loadFirebaseConfig = async function loadFirebaseConfig(){
      try {
        if (window.FIREBASE_API_KEY && window.FIREBASE_PROJECT_ID) return true;
        const res = await fetch('/api/env');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const cfg = await res.json();
        if (!cfg.FIREBASE_API_KEY || !cfg.FIREBASE_PROJECT_ID) throw new Error('Missing required Firebase configuration');
        window.FIREBASE_API_KEY = cfg.FIREBASE_API_KEY;
        window.FIREBASE_AUTH_DOMAIN = cfg.FIREBASE_AUTH_DOMAIN;
        window.FIREBASE_PROJECT_ID = cfg.FIREBASE_PROJECT_ID;
        window.FIREBASE_STORAGE_BUCKET = cfg.FIREBASE_STORAGE_BUCKET;
        window.FIREBASE_MESSAGING_SENDER_ID = cfg.FIREBASE_MESSAGING_SENDER_ID;
        window.FIREBASE_APP_ID = cfg.FIREBASE_APP_ID;
        return true;
      } catch (err) {
        console.error('Failed to load Firebase config:', err);
        showToast('Application configuration error. Please contact administrator.', 'error');
        return false;
      }
    }
  </script>
  
  <script>
    window.env = {
      FIREBASE_API_KEY: window.FIREBASE_API_KEY || "",
      FIREBASE_AUTH_DOMAIN: window.FIREBASE_AUTH_DOMAIN || "",
      FIREBASE_PROJECT_ID: window.FIREBASE_PROJECT_ID || "",
      FIREBASE_STORAGE_BUCKET: window.FIREBASE_STORAGE_BUCKET || "",
      FIREBASE_MESSAGING_SENDER_ID: window.FIREBASE_MESSAGING_SENDER_ID || "",
      FIREBASE_APP_ID: window.FIREBASE_APP_ID || ""
    };
  </script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore-lite.js";
    import { jsPDF } from "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.es.min.js";
    import JSZip from "https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js";

    const ok = await window.loadFirebaseConfig();
    if (!ok) throw new Error('Firebase configuration failed to load');
    
    const cfg = {
      apiKey: window.FIREBASE_API_KEY,
      authDomain: window.FIREBASE_AUTH_DOMAIN,
      projectId: window.FIREBASE_PROJECT_ID,
      storageBucket: window.FIREBASE_STORAGE_BUCKET,
      messagingSenderId: window.FIREBASE_MESSAGING_SENDER_ID,
      appId: window.FIREBASE_APP_ID,
    };
    
    const app = initializeApp(cfg);
    const db = getFirestore(app);

    const form = document.getElementById('lookupForm');
    const result = document.getElementById('result');
    const kvPanel = document.getElementById('kvPanel');
    const searchBy = document.getElementById('searchBy');
    const fieldFormNumber = document.getElementById('fieldFormNumber');
    const fieldEmail = document.getElementById('fieldEmail');
    const fieldPhone = document.getElementById('fieldPhone');
    const matches = document.getElementById('matches');
    const matchSelect = document.getElementById('matchSelect');
    const inputForm = fieldFormNumber.querySelector('input');
    const inputEmail = fieldEmail.querySelector('input');
    const inputPhone = fieldPhone.querySelector('input');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const exportAllPdfBtn = document.getElementById('exportAllPdfBtn');
    const exportAllDataBtn = document.getElementById('exportAllDataBtn');
    const exportProgress = document.getElementById('exportProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    let currentRecord = null;
    let currentMatches = [];

    function updateInputs() {
      const mode = searchBy.value;
      
      // Reset all fields
      fieldFormNumber.classList.add('hidden');
      fieldEmail.classList.add('hidden');
      fieldPhone.classList.add('hidden');
      
      // Show only the selected field
      if (mode === 'form_number') {
        fieldFormNumber.classList.remove('hidden');
        inputForm.required = true;
        inputEmail.required = false;
        inputPhone.required = false;
      } else if (mode === 'email') {
        fieldEmail.classList.remove('hidden');
        inputForm.required = false;
        inputEmail.required = true;
        inputPhone.required = false;
      } else if (mode === 'phone') {
        fieldPhone.classList.remove('hidden');
        inputForm.required = false;
        inputEmail.required = false;
        inputPhone.required = true;
      }
      
      // Hide results when changing search type
      matches.classList.add('hidden');
      result.classList.add('hidden');
      kvPanel.innerHTML = '';
    }

    // Initialize the form
    updateInputs();
    
    // Update inputs when search type changes
    searchBy.addEventListener('change', updateInputs);

    // Form submission handler
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const mode = searchBy.value;
      let queryValue = '';
      
      // Get the appropriate input value based on search type
      if (mode === 'form_number') {
        queryValue = inputForm.value.trim();
        if (!queryValue) {
          showToast('Please enter a form number.', 'error');
          return;
        }
      } else if (mode === 'email') {
        queryValue = inputEmail.value.trim();
        if (!queryValue) {
          showToast('Please enter an email address.', 'error');
          return;
        }
      } else if (mode === 'phone') {
        queryValue = inputPhone.value.trim();
        if (!queryValue) {
          showToast('Please enter a phone number.', 'error');
          return;
        }
      }
      
      try {
        if (mode === 'form_number') {
          // Pad with zeros to ensure 6-digit format
          const id = String(queryValue).padStart(6, '0');
          const snap = await getDoc(doc(db, 'records', id));
          
          if (!snap.exists()) {
            showToast('No record found for that form number.', 'error');
            return;
          }
          
          currentRecord = { id, ...snap.data() };
          showRecord(currentRecord);
        } else if (mode === 'email') {
          const qy = query(collection(db, 'records'), where('email', '==', queryValue));
          const snaps = await getDocs(qy);
          handleMatches(snaps);
        } else if (mode === 'phone') {
          const qy = query(collection(db, 'records'), where('phone', '==', queryValue));
          const snaps = await getDocs(qy);
          handleMatches(snaps);
        }
      } catch (err) {
        console.error('Search error:', err);
        showToast('Failed to search records. Please try again.', 'error');
      }
    });

    function handleMatches(snaps) {
      currentMatches = snaps.docs.map(d => ({ id: d.id, ...d.data() }));
      
      if (!currentMatches.length) {
        matches.classList.add('hidden');
        result.classList.add('hidden');
        showToast('No matching records found.', 'error');
        return;
      }
      
      if (currentMatches.length === 1) {
        // If only one match, show it directly
        currentRecord = currentMatches[0];
        showRecord(currentRecord);
        matches.classList.add('hidden');
        return;
      }
      
      // Multiple matches - show selection dropdown
      matchSelect.innerHTML = currentMatches.map(r => 
        `<option value="${r.id}">${r.id} - ${escapeHtml(r.full_name || 'Unnamed')}</option>`
      ).join('');
      
      matches.classList.remove('hidden');
      result.classList.add('hidden');
    }

    matchSelect.addEventListener('change', () => {
      const id = matchSelect.value;
      const rec = currentMatches.find(r => r.id === id);
      
      if (rec) {
        currentRecord = rec;
        showRecord(currentRecord);
      }
    });

    function showRecord(r) {
      result.classList.remove('hidden');
      
      const entries = [
        ['Form #', r.form_number || r.id],
        ['Full Name', r.full_name],
        ["Father's Name", r.father_name],
        ["Mother's Name", r.mother_name],
        ['Gender', r.gender],
        ['Date of Birth', r.dob],
        ['Institute', r.institute],
        ['Class', r.class],
        ['Section', r.section],
        ['Phone', r.phone],
        ['Email', r.email],
        ['Address', r.address],
        ['Landmark', r.landmark],
        ['City', r.city],
        ['Category', r.category]
      ];
      
      kvPanel.innerHTML = entries.map(([k, v]) => `
        <div class="k">${escapeHtml(k)}</div>
        <div>${escapeHtml(v || 'Not provided')}</div>
      `).join('');
    }

    function escapeHtml(s = '') { 
      return s.toString().replace(/[&<>\"]/g, c => 
        ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c])
      ); 
    }

    // Single PDF Download
    downloadPdfBtn.addEventListener('click', () => {
      if (!currentRecord) {
        showToast('No record to download.', 'error');
        return;
      }
      
      try {
        const r = currentRecord;
        const doc = new jsPDF();
        let y = 20;
        
        // Header
        doc.setFontSize(20);
        doc.setTextColor(40, 40, 40);
        doc.text('SJR MUN REGISTRATION', 105, y, { align: 'center' });
        y += 10;
        
        doc.setFontSize(12);
        doc.setTextColor(100, 100, 100);
        doc.text(`Form Number: ${r.form_number || r.id}`, 105, y, { align: 'center' });
        y += 15;
        
        // Divider line
        doc.setDrawColor(200, 200, 200);
        doc.line(20, y, 190, y);
        y += 10;
        
        // Form details
        doc.setFontSize(11);
        doc.setTextColor(40, 40, 40);
        
        const pairs = [
          ['Full Name', r.full_name || 'Not provided'],
          ["Father's Name", r.father_name || 'Not provided'],
          ["Mother's Name", r.mother_name || 'Not provided'],
          ['Gender', r.gender || 'Not provided'],
          ['Date of Birth', r.dob || 'Not provided'],
          ['Institute', r.institute || 'Not provided'],
          ['Class', r.class || 'Not provided'],
          ['Section', r.section || 'Not provided'],
          ['Phone', r.phone || 'Not provided'],
          ['Email', r.email || 'Not provided'],
          ['Address', r.address || 'Not provided'],
          ['Landmark', r.landmark || 'Not provided'],
          ['City', r.city || 'Not provided'],
          ['Category', r.category || 'Not provided']
        ];
        
        for (const [k, v] of pairs) {
          const label = `${k}:`;
          const value = v;
          
          doc.setFont(undefined, 'bold');
          doc.text(label, 20, y);
          doc.setFont(undefined, 'normal');
          
          const valueLines = doc.splitTextToSize(value, 120);
          doc.text(valueLines, 70, y);
          
          y += valueLines.length * 6 + 4;
          
          // Add new page if we're running out of space
          if (y > 270) {
            doc.addPage();
            y = 20;
          }
        }
        
        // Footer
        y = 280;
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text('Generated by SJR MUN Club Registration System', 105, y, { align: 'center' });
        
        // Save the PDF
        doc.save(`sjr_mun_form_${r.form_number || r.id}.pdf`);
        showToast('PDF downloaded successfully!', 'success');
      } catch (error) {
        console.error('PDF generation error:', error);
        showToast('Failed to generate PDF. Please try again.', 'error');
      }
    });

    // Export All PDFs
    exportAllPdfBtn.addEventListener('click', async () => {
      try {
        exportAllPdfBtn.disabled = true;
        exportAllPdfBtn.innerHTML = '<div class="loading"></div> Exporting...';
        exportProgress.classList.remove('hidden');
        
        // Get all records
        const q = query(collection(db, 'records'), orderBy('form_number'));
        const snapshot = await getDocs(q);
        const allRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        if (allRecords.length === 0) {
          showToast('No records found to export.', 'error');
          return;
        }
        
        const zip = new JSZip();
        let processed = 0;
        
        // Process each record and create PDF
        for (const record of allRecords) {
          try {
            const doc = new jsPDF();
            let y = 20;
            
            // Header
            doc.setFontSize(20);
            doc.setTextColor(40, 40, 40);
            doc.text('SJR MUN REGISTRATION', 105, y, { align: 'center' });
            y += 10;
            
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text(`Form Number: ${record.form_number || record.id}`, 105, y, { align: 'center' });
            y += 15;
            
            // Divider line
            doc.setDrawColor(200, 200, 200);
            doc.line(20, y, 190, y);
            y += 10;
            
            // Form details
            doc.setFontSize(11);
            doc.setTextColor(40, 40, 40);
            
            const pairs = [
              ['Full Name', record.full_name || 'Not provided'],
              ["Father's Name", record.father_name || 'Not provided'],
              ["Mother's Name", record.mother_name || 'Not provided'],
              ['Gender', record.gender || 'Not provided'],
              ['Date of Birth', record.dob || 'Not provided'],
              ['Institute', record.institute || 'Not provided'],
              ['Class', record.class || 'Not provided'],
              ['Section', record.section || 'Not provided'],
              ['Phone', record.phone || 'Not provided'],
              ['Email', record.email || 'Not provided'],
              ['Address', record.address || 'Not provided'],
              ['Landmark', record.landmark || 'Not provided'],
              ['City', record.city || 'Not provided'],
              ['Category', record.category || 'Not provided']
            ];
            
            for (const [k, v] of pairs) {
              const label = `${k}:`;
              const value = v;
              
              doc.setFont(undefined, 'bold');
              doc.text(label, 20, y);
              doc.setFont(undefined, 'normal');
              
              const valueLines = doc.splitTextToSize(value, 120);
              doc.text(valueLines, 70, y);
              
              y += valueLines.length * 6 + 4;
              
              if (y > 270) {
                doc.addPage();
                y = 20;
              }
            }
            
            // Footer
            y = 280;
            doc.setFontSize(8);
            doc.setTextColor(150, 150, 150);
            doc.text('Generated by SJR MUN Club Registration System', 105, y, { align: 'center' });
            
            // Add PDF to zip
            const pdfData = doc.output('arraybuffer');
            zip.file(`sjr_mun_form_${record.form_number || record.id}.pdf`, pdfData);
            
          } catch (error) {
            console.error(`Error generating PDF for record ${record.id}:`, error);
          }
          
          processed++;
          const progress = Math.round((processed / allRecords.length) * 100);
          progressBar.style.width = `${progress}%`;
          progressText.textContent = `${progress}% (${processed}/${allRecords.length})`;
        }
        
        // Generate and download zip file
        const zipBlob = await zip.generateAsync({ type: 'blob' });
        const url = URL.createObjectURL(zipBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sjr_mun_forms_${new Date().toISOString().split('T')[0]}.zip`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast(`Successfully exported ${allRecords.length} forms as PDFs!`, 'success');
        
      } catch (error) {
        console.error('Export All PDFs error:', error);
        showToast('Failed to export PDFs. Please try again.', 'error');
      } finally {
        exportAllPdfBtn.disabled = false;
        exportAllPdfBtn.innerHTML = 'Export All PDFs';
        exportProgress.classList.add('hidden');
        progressBar.style.width = '0%';
        progressText.textContent = '0%';
      }
    });

    // Export All Data as CSV
    exportAllDataBtn.addEventListener('click', async () => {
      try {
        exportAllDataBtn.disabled = true;
        exportAllDataBtn.innerHTML = '<div class="loading"></div> Exporting...';
        
        // Get all records
        const q = query(collection(db, 'records'), orderBy('form_number'));
        const snapshot = await getDocs(q);
        const allRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        if (allRecords.length === 0) {
          showToast('No records found to export.', 'error');
          return;
        }
        
        // Create CSV content
        const headers = [
          'Form Number',
          'Full Name',
          'Father\'s Name',
          'Mother\'s Name',
          'Gender',
          'Date of Birth',
          'Institute',
          'Class',
          'Section',
          'Phone',
          'Email',
          'Address',
          'Landmark',
          'City',
          'Category'
        ];
        
        let csvContent = headers.join(',') + '\n';
        
        for (const record of allRecords) {
          const row = [
            `"${record.form_number || record.id}"`,
            `"${record.full_name || ''}"`,
            `"${record.father_name || ''}"`,
            `"${record.mother_name || ''}"`,
            `"${record.gender || ''}"`,
            `"${record.dob || ''}"`,
            `"${record.institute || ''}"`,
            `"${record.class || ''}"`,
            `"${record.section || ''}"`,
            `"${record.phone || ''}"`,
            `"${record.email || ''}"`,
            `"${record.address || ''}"`,
            `"${record.landmark || ''}"`,
            `"${record.city || ''}"`,
            `"${record.category || ''}"`
          ];
          csvContent += row.join(',') + '\n';
        }
        
        // Create and download CSV file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `sjr_mun_data_${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast(`Successfully exported ${allRecords.length} records as CSV!`, 'success');
        
      } catch (error) {
        console.error('Export All Data error:', error);
        showToast('Failed to export data. Please try again.', 'error');
      } finally {
        exportAllDataBtn.disabled = false;
        exportAllDataBtn.innerHTML = 'Export All Data (CSV)';
      }
    });
  </script>
</body>
</html>