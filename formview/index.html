<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SJR MUN View / Download Your Form</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../handler/styles.css" />
  <link rel="icon" type="image/x-icon" href="../favicon.ico" />
  
  <!-- Load jsPDF via script tag -->
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  
  <style>
    body { 
      min-height: 100vh; 
      background: radial-gradient(1200px 600px at 20% -10%, #7c3aed22, transparent), 
                  radial-gradient(1000px 500px at 120% 10%, #06b6d422, transparent), 
                  linear-gradient(180deg, #0b1020, #0f172a); 
      color: #e5e7eb; 
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }
    
    /* Top Task Bar - Same style as registration form */
    .top-task-bar {
      position: sticky;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: rgba(17, 24, 39, 0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid #1f2937;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 20px rgba(0,0,0,.3);
    }
    
    .task-bar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .task-bar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .task-bar-logo {
      font-weight: 700;
      font-size: 18px;
      background: linear-gradient(135deg, #9ef01a, #b9ff2b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .task-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: #cbd5e1;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.2s ease;
      cursor: pointer;
      font-family: inherit;
    }
    
    .task-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #f8fafc;
      transform: translateY(-1px);
    }
    
    .task-btn.primary {
      background: rgba(158, 240, 26, 0.1);
      border-color: rgba(158, 240, 26, 0.3);
      color: #9ef01a;
    }
    
    .task-btn.primary:hover {
      background: rgba(158, 240, 26, 0.2);
    }
    
    .task-btn.home {
      background: transparent;
      border: 1px solid #9ef01a;
      color: #9ef01a;
      box-shadow: none;
    }
    
    .task-btn.home:hover {
      background: rgba(158, 240, 26, 0.1);
    }
    
    .view-shell { 
      padding: 24px; 
      box-sizing: border-box;
      max-width: 1200px;
      margin: 0 auto;
      padding-top: 80px; /* Space for fixed task bar */
    }
    
    .view-card { 
      width: 100%; 
      max-width: 820px; 
      background: rgba(17, 24, 39, 0.7); 
      backdrop-filter: blur(8px); 
      border: 1px solid #1f2937; 
      border-radius: 16px; 
      box-shadow: 0 20px 60px rgba(0,0,0,.45); 
      padding: 32px; 
      box-sizing: border-box;
      margin: 0 auto;
    }
    
    .header { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 12px; 
      margin-bottom: 24px; 
    }
    
    .header .title { 
      margin: 0; 
      font-size: 24px; 
      color: #f8fafc; 
      font-weight: 600;
    }
    
    .form .field span { 
      color: #cbd5e1; 
      font-weight: 500;
      margin-bottom: 8px;
      display: block;
    }
    
    .form input, .form select, .form textarea { 
      background: #0b1220; 
      border: 1px solid #1f2937; 
      color: #e5e7eb; 
      border-radius: 10px; 
      padding: 12px 16px; 
      outline: none; 
      transition: .2s border-color, .2s box-shadow; 
      width: 100%;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    
    .form textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .form input:focus, .form select:focus, .form textarea:focus { 
      border-color: #6366f1; 
      box-shadow: 0 0 0 4px #6366f11f; 
    }
    
    .actions { 
      display: flex;
      gap: 12px;
      margin-top: 24px;
      flex-wrap: wrap;
    }
    
    .btn { 
      border-radius: 10px; 
      padding: 12px 24px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn.primary, .btn { 
      background: linear-gradient(135deg, #9ef01a, #b9ff2b); 
      border: none; 
      color: #0b1220; 
      box-shadow: 0 10px 24px rgba(158,240,26,.18); 
    }
    
    .btn.primary:hover, .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(158,240,26,.25);
    }
    
    .btn.ghost { 
      background: #111827; 
      border: 1px solid #1f2937; 
      color: #cbd5e1; 
    }
    
    .btn.ghost:hover {
      background: #1f2937;
    }
    
    #matches .field span { 
      color: #cbd5e1; 
    }
    
    .kv { 
      display: grid; 
      grid-template-columns: 180px 1fr; 
      gap: 16px;
      margin-top: 16px;
    }
    
    .kv .k { 
      color: #94a3b8; 
      font-weight: 500;
    }
    
    .kv .v {
      word-break: break-word;
    }
    
    .hidden { 
      display: none !important; 
    }
    
    #result { 
      margin-top: 24px; 
      padding: 24px; 
      background: #0b1220; 
      border: 1px solid #1f2937; 
      border-radius: 12px; 
    }
    
    .toast {
      position: fixed;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%) translateY(20px);
      opacity: 0;
      pointer-events: none;
      background: #0b1220;
      border: 1px solid #1f2937;
      color: #e5e7eb;
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: 0 20px 50px rgba(0,0,0,.5);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 260px;
      z-index: 1001;
      transition: .25s opacity, .25s transform;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
      pointer-events: auto;
    }
    
    .toast.success {
      border-color: rgba(158,240,26,.5);
    }
    
    .toast.error {
      border-color: #7f1d1d;
    }
    
    .field.error input, .field.error select, .field.error textarea {
      border-color: #ef4444 !important;
      box-shadow: 0 0 0 2px rgba(239,68,68,0.2) !important;
    }
    
    .error-message {
      color: #ef4444;
      font-size: 12px;
      margin-top: 4px;
      display: none;
    }
    
    .field.error .error-message {
      display: block;
    }
    
    /* Edit Form Styles */
    #editForm {
      margin-top: 24px;
      padding: 24px;
      background: #0b1220;
      border: 1px solid #1f2937;
      border-radius: 12px;
    }
    
    .edit-form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-top: 16px;
    }
    
    .edit-form-grid .span-2 {
      grid-column: span 2;
    }
    
    .field-inline {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      padding: 12px 0;
    }
    
    .field-inline legend {
      width: 100%;
      color: #cbd5e1;
      font-weight: 500;
      margin-bottom: 8px;
    }
    
    .radio {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    
    .radio input[type="radio"] {
      margin: 0;
    }
    
    .radio span {
      color: #cbd5e1;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #9ef01a;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .view-shell {
        padding: 16px;
        padding-top: 70px;
      }
      
      .view-card {
        padding: 20px;
      }
      
      .top-task-bar {
        padding: 10px 16px;
      }
      
      .task-btn span:not(.loading-spinner) {
        display: none;
      }
      
      .task-btn {
        padding: 8px 12px;
      }
      
      .kv {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      
      .edit-form-grid {
        grid-template-columns: 1fr;
      }
      
      .edit-form-grid .span-2 {
        grid-column: span 1;
      }
    }
  </style>
</head>
<body>
  <!-- Top Task Bar -->
  <div class="top-task-bar">
    <div class="task-bar-left">
      <a href="../" class="task-bar-logo">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
          <path d="M3 9.5 12 3l9 6.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V9.5z"/>
        </svg>
        SJR MUN
      </a>
      <a href="../" class="task-btn home">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
          <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
        </svg>
        <span>Home</span>
      </a>
    </div>
    <div class="task-bar-right">
      <a href="../admin" class="task-btn primary">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
          <path d="M12 8.5a3.5 3.5 0 1 1 0 7 3.5 3.5 0 0 1 0-7zm9 3.5c0-.5-.04-.98-.12-1.45l2.02-1.57-2-3.46-2.44 1a8.9 8.9 0 0 0-2.51-1.45l-.37-2.6H10.4l-.37 2.6c-.9.3-1.74.75-2.51 1.45l-2.44-1-2 3.46 2.02 1.57c-.08.47-.12.95-.12 1.45s.04.98.12 1.45L1.08 15l2 3.46 2.44-1c.77.7 1.61 1.15 2.51 1.45l.37 2.6h3.68l.37-2.6c.9-.3 1.74-.75 2.51-1.45l2.44 1 2-3.46-2.02-1.57c.08-.47.12-.95.12-1.45z"/>
        </svg>
        <span>Admin Panel</span>
      </a>
    </div>
  </div>
  
  <div class="view-shell">
    <div class="view-card">
      <div class="header">
        <h2 class="section-title">Find Your Registration</h2>
      </div>
      <form id="lookupForm" class="form" novalidate>
        <div class="grid">
          <label class="field">
            <span>Search By</span>
            <select name="search_by" id="searchBy">
              <option value="email" selected>Email</option>
              <option value="phone">Phone</option>
            </select>
          </label>
          <label class="field" id="fieldEmail">
            <span>Email</span>
            <input type="email" name="email" placeholder="you@example.com" required />
            <div class="error-message">Please enter a valid email address</div>
          </label>
          <label class="field hidden" id="fieldPhone">
            <span>Phone</span>
            <input type="tel" name="phone" inputmode="numeric" placeholder="10-digit phone" pattern="[0-9]{10}" required />
            <div class="error-message">Please enter a valid 10-digit phone number</div>
          </label>
        </div>
        <div class="actions">
          <button type="submit" class="btn primary">Search</button>
        </div>
      </form>

      <div id="matches" class="hidden" style="margin-top: 24px;">
        <label class="field">
          <span>Select Your Form</span>
          <select id="matchSelect"></select>
        </label>
      </div>

      <div id="result" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap;">
          <h3 style="margin: 0; color: #f8fafc;">Form Details</h3>
          <div style="display: flex; gap: 12px;">
            <button id="downloadPdfBtn" class="btn">Download PDF</button>
            <button id="editFormBtn" class="btn ghost">Edit Missing Data</button>
          </div>
        </div>
        <div id="kvPanel" class="kv" style="margin-top: 16px;"></div>
      </div>

      <!-- Edit Form (Hidden by default) -->
      <div id="editForm" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 20px;">
          <h3 style="margin: 0; color: #f8fafc;">Edit Form Data</h3>
          <button id="cancelEditBtn" class="btn ghost">Cancel</button>
        </div>
        <form id="updateForm" class="form" novalidate>
          <div class="edit-form-grid">
            <label class="field">
              <span>Full Name</span>
              <input type="text" name="full_name" id="edit_full_name" placeholder="Full Name" required />
              <div class="error-message">Please enter full name</div>
            </label>

            <label class="field">
              <span>Father's Name</span>
              <input type="text" name="father_name" id="edit_father_name" placeholder="Father's Name" required />
              <div class="error-message">Please enter father's name</div>
            </label>

            <label class="field">
              <span>Mother's Name</span>
              <input type="text" name="mother_name" id="edit_mother_name" placeholder="Mother's Name" required />
              <div class="error-message">Please enter mother's name</div>
            </label>

            <fieldset class="field field-inline" id="edit_genderField">
              <legend>Gender</legend>
              <label class="radio"><input type="radio" name="gender" value="Male" required /> <span>Male</span></label>
              <label class="radio"><input type="radio" name="gender" value="Female" required /> <span>Female</span></label>
              <label class="radio"><input type="radio" name="gender" value="Other" required /> <span>Other</span></label>
              <div class="error-message">Please select gender</div>
            </fieldset>

            <label class="field">
              <span>Date of Birth</span>
              <input type="date" name="dob" id="edit_dob" required />
              <div class="error-message">Please select date of birth</div>
            </label>

            <label class="field span-2">
              <span>Institution / School / College name</span>
              <input type="text" name="institute" id="edit_institute" placeholder="Institution / School / College" required />
              <div class="error-message">Please enter institution name</div>
            </label>

            <label class="field">
              <span>Class</span>
              <select name="class" id="edit_class" required>
                <option value="" selected disabled>Select</option>
                <option>6</option>
                <option>7</option>
                <option>8</option>
                <option>9</option>
                <option>10</option>
                <option>11</option>
                <option>12</option>
              </select>
              <div class="error-message">Please select class</div>
            </label>

            <label class="field">
              <span>Phone No.</span>
              <input type="tel" name="phone" id="edit_phone" inputmode="numeric" placeholder="Enter your phone No" pattern="[0-9]{10}" required />
              <div class="error-message">Please enter valid 10-digit phone number</div>
            </label>

            <label class="field">
              <span>Email</span>
              <input type="email" name="email" id="edit_email" placeholder="Enter your Email" required />
              <div class="error-message">Please enter valid email address</div>
            </label>

            <label class="field span-2">
              <span>Address</span>
              <input type="text" name="address" id="edit_address" placeholder="Address" />
            </label>

            <label class="field">
              <span>Landmark</span>
              <input type="text" name="landmark" id="edit_landmark" placeholder="Landmark" />
            </label>

            <label class="field">
              <span>City</span>
              <input type="text" name="city" id="edit_city" placeholder="City" />
            </label>

            <label class="field span-2">
              <span>Department</span>
              <input type="text" name="department" id="edit_department" placeholder="Department" required />
              <div class="error-message">Please enter department</div>
            </label>
          </div>
          <div class="actions">
            <button type="submit" class="btn primary" id="updateBtn">
              Update Form
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="popup" class="toast hidden">
    <span id="popupText"></span>
    <button id="popupClose" class="btn ghost">Close</button>
  </div>

  <script>
    // Toast functionality
    function ensureToast(){
      let el = document.getElementById('popup');
      if (!el) {
        el = document.createElement('div');
        el.id = 'popup';
        el.className = 'toast hidden';
        el.innerHTML = '<span id="popupText"></span><button id="popupClose" class="btn ghost">Close</button>';
        document.body.appendChild(el);
        const close = el.querySelector('#popupClose');
        close.addEventListener('click', () => { 
          el.classList.remove('show','success','error'); 
        });
      }
      return el;
    }
    
    function showToast(msg, kind='success'){
      const el = ensureToast();
      const text = el.querySelector('#popupText');
      if (text) text.textContent = msg;
      el.classList.remove('success','error');
      el.classList.add('show', kind);
      clearTimeout(el.__hideT);
      el.__hideT = setTimeout(() => el.classList.remove('show','success','error'), 6000);
    }

    // Debug logging system
    window.debugLog = [];
    
    function addDebugLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = { timestamp, message, type };
      window.debugLog.push(logEntry);
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    window.loadFirebaseConfig = async function loadFirebaseConfig(){
      try {
        addDebugLog('Loading Firebase configuration...', 'info');
        
        if (window.FIREBASE_API_KEY && window.FIREBASE_PROJECT_ID) {
          addDebugLog('Firebase config already loaded', 'success');
          return true;
        }
        
        let cfg = null;
        if (location.protocol === 'http:' || location.protocol === 'https:') {
          try {
            addDebugLog('Fetching config from /api/env', 'info');
            const res = await fetch('/api/env');
            if (!res.ok) {
              const errorText = await res.text();
              throw new Error(`HTTP ${res.status}: ${errorText}`);
            }
            cfg = await res.json();
            addDebugLog('Received config from API', 'success');
          } catch (apiErr) {
            addDebugLog(`API config load failed: ${apiErr.message}`, 'error');
          }
        } else {
          addDebugLog('Running from file:// or unknown protocol; skipping API fetch', 'info');
        }

        if (!cfg && window.__FIREBASE_CONFIG__) {
          addDebugLog('Using window.__FIREBASE_CONFIG__ fallback', 'info');
          cfg = window.__FIREBASE_CONFIG__;
        }

        if (!cfg) {
          throw new Error('Firebase config not found. Provide /api/env or window.__FIREBASE_CONFIG__.');
        }
        
        if (!cfg.FIREBASE_API_KEY || !cfg.FIREBASE_PROJECT_ID) {
          throw new Error('Missing required Firebase configuration (API_KEY or PROJECT_ID)');
        }
        
        window.FIREBASE_API_KEY = cfg.FIREBASE_API_KEY;
        window.FIREBASE_AUTH_DOMAIN = cfg.FIREBASE_AUTH_DOMAIN || `${cfg.FIREBASE_PROJECT_ID}.firebaseapp.com`;
        window.FIREBASE_PROJECT_ID = cfg.FIREBASE_PROJECT_ID;
        window.FIREBASE_STORAGE_BUCKET = cfg.FIREBASE_STORAGE_BUCKET || `${cfg.FIREBASE_PROJECT_ID}.appspot.com`;
        window.FIREBASE_MESSAGING_SENDER_ID = cfg.FIREBASE_MESSAGING_SENDER_ID;
        window.FIREBASE_APP_ID = cfg.FIREBASE_APP_ID;
        
        addDebugLog('Firebase configuration loaded successfully', 'success');
        return true;
        
      } catch (err) {
        addDebugLog(`Failed to load Firebase config: ${err.message}`, 'error');
        showToast('Configuration error: ' + err.message, 'error');
        return false;
      }
    }
  </script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, query, where, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore-lite.js";

    // DOM elements
    const form = document.getElementById('lookupForm');
    const result = document.getElementById('result');
    const kvPanel = document.getElementById('kvPanel');
    const searchBy = document.getElementById('searchBy');
    const fieldEmail = document.getElementById('fieldEmail');
    const fieldPhone = document.getElementById('fieldPhone');
    const matches = document.getElementById('matches');
    const matchSelect = document.getElementById('matchSelect');
    const inputEmail = fieldEmail.querySelector('input');
    const inputPhone = fieldPhone.querySelector('input');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    const editFormBtn = document.getElementById('editFormBtn');
    const editForm = document.getElementById('editForm');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const updateForm = document.getElementById('updateForm');
    const updateBtn = document.getElementById('updateBtn');

    let currentRecord = null;
    let currentMatches = [];
    let db = null;

    // Initialize Firebase
    async function initializeFirebase() {
      try {
        addDebugLog('Initializing Firebase...', 'info');
        
        const ok = await window.loadFirebaseConfig();
        if (!ok) {
          throw new Error('Firebase configuration failed to load');
        }
        
        const cfg = {
          apiKey: window.FIREBASE_API_KEY,
          authDomain: window.FIREBASE_AUTH_DOMAIN,
          projectId: window.FIREBASE_PROJECT_ID,
          storageBucket: window.FIREBASE_STORAGE_BUCKET,
          messagingSenderId: window.FIREBASE_MESSAGING_SENDER_ID,
          appId: window.FIREBASE_APP_ID,
        };
        
        addDebugLog('Firebase config validated', 'success');
        const app = initializeApp(cfg);
        db = getFirestore(app);
        addDebugLog('Firebase Firestore initialized successfully', 'success');
        
        return true;
      } catch (error) {
        addDebugLog(`Firebase initialization failed: ${error.message}`, 'error');
        showToast('Firebase initialization failed: ' + error.message, 'error');
        return false;
      }
    }

    // Form input management
    function updateInputs() {
      const mode = searchBy.value;
      addDebugLog(`Search mode changed to: ${mode}`, 'info');
      
      fieldEmail.classList.add('hidden');
      fieldPhone.classList.add('hidden');
      
      if (mode === 'email') {
        fieldEmail.classList.remove('hidden');
        inputEmail.required = true;
        inputPhone.required = false;
      } else if (mode === 'phone') {
        fieldPhone.classList.remove('hidden');
        inputEmail.required = false;
        inputPhone.required = true;
      }
      
      matches.classList.add('hidden');
      result.classList.add('hidden');
      editForm.classList.add('hidden');
      kvPanel.innerHTML = '';
    }

    // Form submission handler
    async function handleFormSubmit(e) {
      e.preventDefault();
      
      const mode = searchBy.value;
      let queryValue = '';
      
      if (mode === 'email') {
        queryValue = inputEmail.value.trim().toLowerCase();
        if (!queryValue) {
          showToast('Please enter an email address.', 'error');
          return;
        }
      } else if (mode === 'phone') {
        queryValue = (inputPhone.value || '').replace(/\D/g, '').trim();
        if (!queryValue) {
          showToast('Please enter a phone number.', 'error');
          return;
        }
      }
      
      addDebugLog(`Searching by ${mode} for: "${queryValue}"`, 'info');
      
      try {
        if (!db) {
          throw new Error('Database not initialized');
        }
        
        if (mode === 'email') {
          addDebugLog('Querying by email...', 'info');
          const qy = query(collection(db, 'records'), where('email', '==', queryValue));
          const snaps = await getDocs(qy);
          addDebugLog(`Found ${snaps.docs.length} matches for email`, 'info');
          handleMatches(snaps);
          
        } else if (mode === 'phone') {
          addDebugLog('Querying by phone...', 'info');
          const qy = query(collection(db, 'records'), where('phone', '==', queryValue));
          const snaps = await getDocs(qy);
          addDebugLog(`Found ${snaps.docs.length} matches for phone`, 'info');
          handleMatches(snaps);
        }
      } catch (err) {
        addDebugLog(`Search error: ${err.message}`, 'error');
        showToast('Failed to search records: ' + err.message, 'error');
      }
    }

    function handleMatches(snaps) {
      currentMatches = snaps.docs.map(d => ({ id: d.id, ...d.data() }));
      addDebugLog(`Processing ${currentMatches.length} matches`, 'info');
      
      if (!currentMatches.length) {
        matches.classList.add('hidden');
        result.classList.add('hidden');
        editForm.classList.add('hidden');
        showToast('No matching records found.', 'error');
        return;
      }
      
      if (currentMatches.length === 1) {
        currentRecord = currentMatches[0];
        addDebugLog(`Single match found: ${currentRecord.id}`, 'success');
        showRecord(currentRecord);
        matches.classList.add('hidden');
        return;
      }
      
      matchSelect.innerHTML = '';
      currentMatches.forEach(record => {
        const option = document.createElement('option');
        option.value = record.id;
        option.textContent = `${record.id} - ${record.full_name || 'Unnamed'}`;
        matchSelect.appendChild(option);
      });
      
      matches.classList.remove('hidden');
      result.classList.add('hidden');
      editForm.classList.add('hidden');
      addDebugLog(`Showing ${currentMatches.length} matches in dropdown`, 'success');
    }

    function showRecord(record) {
      addDebugLog(`Displaying record: ${record.id}`, 'info');
      result.classList.remove('hidden');
      editForm.classList.add('hidden');
      
      kvPanel.innerHTML = '';
      
      const entries = [
        ['Form #', record.form_number || record.id],
        ['Full Name', record.full_name || 'Not provided'],
        ["Father's Name", record.father_name || 'Not provided'],
        ["Mother's Name", record.mother_name || 'Not provided'],
        ['Gender', record.gender || 'Not provided'],
        ['Date of Birth', record.dob || 'Not provided'],
        ['Institute', record.institute || 'Not provided'],
        ['Class', record.class || 'Not provided'],
        ['Phone', record.phone || 'Not provided'],
        ['Email', record.email || 'Not provided'],
        ['Address', record.address || 'Not provided'],
        ['Landmark', record.landmark || 'Not provided'],
        ['City', record.city || 'Not provided'],
        ['Department', record.department || 'Not provided']
      ];
      
      entries.forEach(([key, value]) => {
        const keyDiv = document.createElement('div');
        keyDiv.className = 'k';
        keyDiv.textContent = key;
        
        const valueDiv = document.createElement('div');
        valueDiv.className = 'v';
        valueDiv.textContent = value;
        
        kvPanel.appendChild(keyDiv);
        kvPanel.appendChild(valueDiv);
      });
      
      addDebugLog('Record displayed successfully', 'success');
    }

    // Edit form functionality
    function openEditForm() {
      if (!currentRecord) {
        showToast('No record selected to edit.', 'error');
        return;
      }
      
      result.classList.add('hidden');
      editForm.classList.remove('hidden');
      
      // Populate edit form with current data
      document.getElementById('edit_full_name').value = currentRecord.full_name || '';
      document.getElementById('edit_father_name').value = currentRecord.father_name || '';
      document.getElementById('edit_mother_name').value = currentRecord.mother_name || '';
      document.getElementById('edit_dob').value = currentRecord.dob || '';
      document.getElementById('edit_institute').value = currentRecord.institute || '';
      document.getElementById('edit_class').value = currentRecord.class || '';
      document.getElementById('edit_phone').value = currentRecord.phone || '';
      document.getElementById('edit_email').value = currentRecord.email || '';
      document.getElementById('edit_address').value = currentRecord.address || '';
      document.getElementById('edit_landmark').value = currentRecord.landmark || '';
      document.getElementById('edit_city').value = currentRecord.city || '';
      document.getElementById('edit_department').value = currentRecord.department || '';
      
      // Set gender radio button
      const genderRadios = document.querySelectorAll('input[name="gender"]');
      genderRadios.forEach(radio => {
        radio.checked = radio.value === currentRecord.gender;
      });
    }

    async function handleUpdateForm(e) {
      e.preventDefault();
      
      // Validate form
      const form = e.target;
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());
      
      // Basic validation
      if (!data.full_name || !data.father_name || !data.mother_name || !data.gender || 
          !data.dob || !data.institute || !data.class || !data.phone || !data.email || !data.department) {
        showToast('Please fill all required fields.', 'error');
        return;
      }
      
      // Phone validation
      const phoneRegex = /^[0-9]{10}$/;
      if (!phoneRegex.test(data.phone)) {
        showToast('Please enter a valid 10-digit phone number.', 'error');
        return;
      }
      
      // Email validation
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(data.email)) {
        showToast('Please enter a valid email address.', 'error');
        return;
      }
      
      updateBtn.disabled = true;
      const originalText = updateBtn.textContent;
      updateBtn.innerHTML = '<span class="loading-spinner"></span> Updating...';
      
      try {
        if (!db || !currentRecord) {
          throw new Error('Database or record not available');
        }
        
        const updatedData = {
          ...currentRecord,
          ...data,
          email: data.email.toLowerCase().trim(),
          phone: data.phone.trim(),
          updated_at: new Date().toISOString()
        };
        
        addDebugLog(`Updating record ${currentRecord.id}`, 'info');
        
        const recordRef = doc(db, 'records', currentRecord.id);
        await updateDoc(recordRef, updatedData);
        
        // Update current record
        currentRecord = updatedData;
        
        showToast('Form updated successfully!', 'success');
        
        // Close edit form and show updated record
        editForm.classList.add('hidden');
        showRecord(currentRecord);
        
      } catch (error) {
        addDebugLog(`Update error: ${error.message}`, 'error');
        showToast('Failed to update form: ' + error.message, 'error');
      } finally {
        updateBtn.disabled = false;
        updateBtn.textContent = originalText;
      }
    }

    function handleDownloadPdf() {
      if (!currentRecord) {
        showToast('No record to download.', 'error');
        return;
      }
      
      addDebugLog('Generating PDF...', 'info');
      
      if (typeof window.jspdf === 'undefined') {
        addDebugLog('jsPDF not loaded', 'error');
        showToast('PDF library not loaded', 'error');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const record = currentRecord;
      const doc = new jsPDF();
      let y = 14;
      
      // Header
      doc.setFontSize(16);
      doc.text('SJR MUN Registration', 14, y);
      y += 8;
      
      doc.setFontSize(12);
      doc.text(`Form # ${record.form_number || record.id}`, 14, y);
      y += 8;
      
      // Divider line
      doc.setDrawColor(200);
      doc.line(14, y, 196, y);
      y += 6;
      
      // Form details
      doc.setFontSize(11);
      const pairs = [
        ['Full Name', record.full_name],
        ["Father's Name", record.father_name],
        ["Mother's Name", record.mother_name],
        ['Gender', record.gender],
        ['Date of Birth', record.dob],
        ['Institute', record.institute],
        ['Class', record.class],
        ['Phone', record.phone],
        ['Email', record.email],
        ['Address', record.address],
        ['Landmark', record.landmark],
        ['City', record.city],
        ['Department', record.department]
      ];
      
      for (const [key, value] of pairs) {
        const text = `${key}: ${value || 'Not provided'}`;
        const lines = doc.splitTextToSize(text, 182);
        doc.text(lines, 14, y);
        y += 6 + (lines.length - 1) * 5;
        
        if (y > 280) {
          doc.addPage();
          y = 14;
        }
      }
      
      const filename = `sjr_mun_form_${record.form_number || record.id}.pdf`;
      doc.save(filename);
      addDebugLog(`PDF downloaded: ${filename}`, 'success');
      showToast('PDF downloaded successfully!', 'success');
    }

    // Event listeners
    function setupEventListeners() {
      searchBy.addEventListener('change', updateInputs);
      form.addEventListener('submit', handleFormSubmit);
      matchSelect.addEventListener('change', handleMatchSelect);
      downloadPdfBtn.addEventListener('click', handleDownloadPdf);
      editFormBtn.addEventListener('click', openEditForm);
      cancelEditBtn.addEventListener('click', () => {
        editForm.classList.add('hidden');
        result.classList.remove('hidden');
      });
      updateForm.addEventListener('submit', handleUpdateForm);
    }

    function handleMatchSelect() {
      const id = matchSelect.value;
      const rec = currentMatches.find(r => r.id === id);
      
      if (rec) {
        currentRecord = rec;
        addDebugLog(`Selected record: ${id}`, 'info');
        showRecord(currentRecord);
      }
    }

    // Initialize the application
    async function init() {
      addDebugLog('Initializing application...', 'info');
      
      updateInputs();
      setupEventListeners();
      
      const firebaseReady = await initializeFirebase();
      if (firebaseReady) {
        addDebugLog('Form View ready', 'success');
        // Removed the "Application loaded successfully!" toast
      } else {
        addDebugLog('Application initialization failed', 'error');
      }
    }

    // Start the application
    init();
  </script>
</body>
</html>
