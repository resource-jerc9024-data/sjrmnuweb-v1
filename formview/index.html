<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SJR MUN View / Download Your Form</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../handler/styles.css" />
  <link rel="icon" type="image/x-icon" href="../favicon.ico" />
  <style>
    body { 
      min-height: 100vh; 
      background: radial-gradient(1200px 600px at 20% -10%, #7c3aed22, transparent), 
                  radial-gradient(1000px 500px at 120% 10%, #06b6d422, transparent), 
                  linear-gradient(180deg, #0b1020, #0f172a); 
      color: #e5e7eb; 
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
    }
    
    .view-shell { 
      display: grid; 
      place-items: center; 
      min-height: 100vh;
      padding: 24px; 
      box-sizing: border-box;
    }
    
    .view-card { 
      width: 100%; 
      max-width: 820px; 
      background: rgba(17, 24, 39, 0.7); 
      backdrop-filter: blur(8px); 
      border: 1px solid #1f2937; 
      border-radius: 16px; 
      box-shadow: 0 20px 60px rgba(0,0,0,.45); 
      padding: 32px; 
      box-sizing: border-box;
    }
    
    .header { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 12px; 
      margin-bottom: 24px; 
    }
    
    .header .title { 
      margin: 0; 
      font-size: 24px; 
      color: #f8fafc; 
      font-weight: 600;
    }
    
    .form .field span { 
      color: #cbd5e1; 
      font-weight: 500;
      margin-bottom: 8px;
      display: block;
    }
    
    .form input, .form select { 
      background: #0b1220; 
      border: 1px solid #1f2937; 
      color: #e5e7eb; 
      border-radius: 10px; 
      padding: 12px 16px; 
      outline: none; 
      transition: .2s border-color, .2s box-shadow; 
      width: 100%;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    
    .form input:focus, .form select:focus { 
      border-color: #6366f1; 
      box-shadow: 0 0 0 4px #6366f11f; 
    }
    
    .actions { 
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .btn { 
      border-radius: 10px; 
      padding: 12px 24px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      font-family: 'Inter', sans-serif;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn.primary, .btn { 
      background: linear-gradient(135deg, #9ef01a, #b9ff2b); 
      border: none; 
      color: #0b1220; 
      box-shadow: 0 10px 24px rgba(158,240,26,.18); 
    }
    
    .btn.primary:hover, .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(158,240,26,.25);
    }
    
    .btn.ghost { 
      background: #111827; 
      border: 1px solid #1f2937; 
      color: #cbd5e1; 
    }
    
    .btn.ghost:hover {
      background: #1f2937;
    }
    
    #matches .field span { 
      color: #cbd5e1; 
    }
    
    .kv { 
      display: grid; 
      grid-template-columns: 180px 1fr; 
      gap: 16px;
      margin-top: 16px;
    }
    
    .kv .k { 
      color: #94a3b8; 
      font-weight: 500;
    }
    
    .hidden { 
      display: none !important; 
    }
    
    #result { 
      margin-top: 24px; 
      padding: 24px; 
      background: #0b1220; 
      border: 1px solid #1f2937; 
      border-radius: 12px; 
    }
    
    .toast {
      position: fixed;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%) translateY(20px);
      opacity: 0;
      pointer-events: none;
      background: #0b1220;
      border: 1px solid #1f2937;
      color: #e5e7eb;
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: 0 20px 50px rgba(0,0,0,.5);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 260px;
      z-index: 1000;
      transition: .25s opacity, .25s transform;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
      pointer-events: auto;
    }
    
    .toast.success {
      border-color: rgba(158,240,26,.5);
    }
    
    .toast.error {
      border-color: #7f1d1d;
    }
    
    .field.error input, .field.error select {
      border-color: #ef4444 !important;
      box-shadow: 0 0 0 2px rgba(239,68,68,0.2) !important;
    }
    
    .error-message {
      color: #ef4444;
      font-size: 12px;
      margin-top: 4px;
      display: none;
    }
    
    .field.error .error-message {
      display: block;
    }
    
    .footer {
      margin-top: 80px;
      margin-bottom: 40px;
      padding-bottom: 22px;
      text-align: center;
      color: #94a3b8;
      font-size: 14px;
    }
    
    .footer-credits {
      margin-top: 8px;
      display: block;
    }
    
    .credit-link {
      color: #9ef01a;
      text-decoration: none;
    }
    
    .credit-link:hover {
      text-decoration: underline;
    }
    
    .footer-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    .social-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: #cbd5e1;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    .social-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #f8fafc;
    }
    
    .social-btn.admin {
      background: rgba(158, 240, 26, 0.1);
      border-color: rgba(158, 240, 26, 0.3);
      color: #9ef01a;
    }
    
    .social-btn.admin:hover {
      background: rgba(158, 240, 26, 0.2);
    }

    .debug-panel {
      margin-top: 20px;
      padding: 16px;
      background: rgba(139, 0, 0, 0.1);
      border: 1px solid rgba(139, 0, 0, 0.3);
      border-radius: 8px;
      font-size: 12px;
      color: #cbd5e1;
    }

    .debug-panel.hidden {
      display: none;
    }

    .debug-log {
      max-height: 200px;
      overflow-y: auto;
      background: #0b1220;
      padding: 12px;
      border-radius: 6px;
      margin-top: 8px;
      font-family: monospace;
      font-size: 11px;
      border: 1px solid #1f2937;
    }

    .debug-entry {
      margin-bottom: 4px;
      padding-bottom: 4px;
      border-bottom: 1px solid #1f2937;
    }

    .debug-entry.error {
      color: #ef4444;
    }

    .debug-entry.success {
      color: #9ef01a;
    }

    .debug-entry.info {
      color: #60a5fa;
    }

    @media (max-width: 768px) {
      .view-card {
        padding: 24px;
      }
      
      .kv {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      
      .footer-bar {
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }
      
      .footer-bar .left,
      .footer-bar .right {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div class="view-shell">
    <header class="hero">
      <h1 class="title glow-title">SJR MUN FORM VIEW</h1>
    </header>
    <div class="view-card">
      <div class="header">
        <h2 class="section-title">Find Your Registration</h2>
      </div>
      <form id="lookupForm" class="form" novalidate>
        <div class="grid">
          <label class="field">
            <span>Search By</span>
            <select name="search_by" id="searchBy">
              <option value="form_number" selected>Form Number</option>
              <option value="email">Email</option>
              <option value="phone">Phone</option>
            </select>
          </label>
          <label class="field" id="fieldFormNumber">
            <span>Form Number</span>
            <input type="text" name="form_number" placeholder="e.g. 000123" required />
            <div class="error-message">Please enter a valid form number</div>
          </label>
          <label class="field hidden" id="fieldEmail">
            <span>Email</span>
            <input type="email" name="email" placeholder="you@example.com" />
            <div class="error-message">Please enter a valid email address</div>
          </label>
          <label class="field hidden" id="fieldPhone">
            <span>Phone</span>
            <input type="tel" name="phone" inputmode="numeric" placeholder="10-digit phone" pattern="[0-9]{10}" />
            <div class="error-message">Please enter a valid 10-digit phone number</div>
          </label>
        </div>
        <div class="actions">
          <button type="submit" class="btn primary">Search</button>
          <button type="button" id="debugBtn" class="btn ghost" style="font-size: 12px;">
            Debug Connection
          </button>
        </div>
      </form>

      <!-- Debug Panel -->
      <div id="debugPanel" class="debug-panel hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <strong>Debug Information</strong>
          <button id="clearDebug" class="btn ghost" style="font-size: 10px; padding: 4px 8px;">Clear</button>
        </div>
        <div id="debugLog" class="debug-log"></div>
      </div>

      <div id="matches" class="hidden" style="margin-top: 24px;">
        <label class="field">
          <span>Select Your Form</span>
          <select id="matchSelect"></select>
        </label>
      </div>

      <div id="result" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
          <h3 style="margin: 0; color: #f8fafc;">Form Details</h3>
          <div>
            <button id="downloadPdfBtn" class="btn">Download PDF</button>
          </div>
        </div>
        <div id="kvPanel" class="kv" style="margin-top: 16px;"></div>
      </div>
    </div>
  </div>
  
  <footer class="footer">
    <small>Designed for SJR MUN CLUB</small>
    <br />
    <span class="footer-credits">Website by <strong><a class="credit-link" href="https://works.onpratiks.com" target="_blank" rel="noopener noreferrer">Pratik</a></strong> © <span id="currentYear"></span></span>
    <div class="footer-bar">
      <div class="left">
        <a class="social-btn" href="https://www.instagram.com/sjrmun" target="_blank" rel="noopener noreferrer" aria-label="Instagram">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
            <path fill="currentColor" d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm0 2a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H7zm5 3.5a5.5 5.5 0 1 1 0 11 5.5 5.5 0 0 1 0-11zm0 2a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7zm5.75-.75a1.25 1.25 0 1 1-2.5 0 1.25 1.25 0 0 1 2.5 0z"/>
          </svg>
          <span>Instagram</span>
        </a>
      </div>
      <div class="right" style="display: flex; gap: 12px; align-items: center;">
        <a class="social-btn admin" href="../" aria-label="Home" style="background: transparent; border: 1px solid var(--primary); color: var(--primary); box-shadow: none;">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
            <path fill="currentColor" d="M3 9.5 12 3l9 6.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V9.5z"/>
          </svg>
          <span>Home</span>
        </a>
        <a class="social-btn admin" href="../admin" aria-label="Admin Panel">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true" focusable="false">
            <path fill="currentColor" d="M12 8.5a3.5 3.5 0 1 1 0 7 3.5 3.5 0 0 1 0-7zm9 3.5c0-.5-.04-.98-.12-1.45l2.02-1.57-2-3.46-2.44 1a8.9 8.9 0 0 0-2.51-1.45l-.37-2.6H10.4l-.37-2.6c-.9.3-1.74.75-2.51 1.45l-2.44 1-2 3.46 2.02 1.57c-.08.47-.12.95-.12 1.45s.04.98.12 1.45L1.08 15l2 3.46 2.44-1c.77.7 1.61 1.15 2.51 1.45l.37 2.6h3.68l.37-2.6c.9-.3 1.74-.75 2.51-1.45l2.44 1 2-3.46-2.02-1.57c.08-.47.12-.95.12-1.45z"/>
          </svg>
          <span>Admin Panel</span>
        </a>
      </div>
    </div>
  </footer>

  <script>
    (function(){
      const el = document.getElementById('currentYear');
      if (el) el.textContent = new Date().getFullYear();
    })();
  </script>
  
  <script>
    (function(){
      function ensureToast(){
        let el = document.getElementById('popup');
        if (!el) {
          el = document.createElement('div');
          el.id = 'popup';
          el.className = 'toast';
          el.innerHTML = '<span id="popupText"></span><button id="popupClose" class="btn ghost">Close</button>';
          document.body.appendChild(el);
          const close = el.querySelector('#popupClose');
          close.addEventListener('click', () => { el.classList.remove('show','success','error'); });
        }
        return el;
      }
      
      window.showToast = function(msg, kind='success'){
        const el = ensureToast();
        const text = el.querySelector('#popupText');
        if (text) text.textContent = msg;
        el.classList.remove('success','error');
        el.classList.add('show', kind);
        clearTimeout(el.__hideT);
        el.__hideT = setTimeout(() => el.classList.remove('show','success','error'), 6000);
      }
    })();
  </script>
  
  <script>
    // Debug logging system
    window.debugLog = [];
    
    function addDebugLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = { timestamp, message, type };
      window.debugLog.push(logEntry);
      
      // Update debug panel if visible
      const debugLogElement = document.getElementById('debugLog');
      if (debugLogElement) {
        const entryElement = document.createElement('div');
        entryElement.className = `debug-entry ${type}`;
        entryElement.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
        debugLogElement.appendChild(entryElement);
        debugLogElement.scrollTop = debugLogElement.scrollHeight;
      }
      
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    window.loadFirebaseConfig = async function loadFirebaseConfig(){
      try {
        addDebugLog('Loading Firebase configuration...', 'info');
        
        // Check if already loaded
        if (window.FIREBASE_API_KEY && window.FIREBASE_PROJECT_ID) {
          addDebugLog('Firebase config already loaded', 'success');
          return true;
        }
        
        addDebugLog('Fetching config from ../api/env', 'info');
        const res = await fetch('../api/env');
        
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        const cfg = await res.json();
        addDebugLog('Received config from API', 'success');
        addDebugLog(`Project ID: ${cfg.FIREBASE_PROJECT_ID}`, 'info');
        
        if (!cfg.FIREBASE_API_KEY || !cfg.FIREBASE_PROJECT_ID) {
          throw new Error('Missing required Firebase configuration (API_KEY or PROJECT_ID)');
        }
        
        // Set all config values
        window.FIREBASE_API_KEY = cfg.FIREBASE_API_KEY;
        window.FIREBASE_AUTH_DOMAIN = cfg.FIREBASE_AUTH_DOMAIN || `${cfg.FIREBASE_PROJECT_ID}.firebaseapp.com`;
        window.FIREBASE_PROJECT_ID = cfg.FIREBASE_PROJECT_ID;
        window.FIREBASE_STORAGE_BUCKET = cfg.FIREBASE_STORAGE_BUCKET || `${cfg.FIREBASE_PROJECT_ID}.appspot.com`;
        window.FIREBASE_MESSAGING_SENDER_ID = cfg.FIREBASE_MESSAGING_SENDER_ID;
        window.FIREBASE_APP_ID = cfg.FIREBASE_APP_ID;
        
        addDebugLog('Firebase configuration loaded successfully', 'success');
        return true;
        
      } catch (err) {
        addDebugLog(`Failed to load Firebase config: ${err.message}`, 'error');
        showToast('Configuration error: ' + err.message, 'error');
        return false;
      }
    }
  </script>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore-lite.js";
    import { jsPDF } from "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.es.min.js";

    // DOM elements
    const form = document.getElementById('lookupForm');
    const result = document.getElementById('result');
    const kvPanel = document.getElementById('kvPanel');
    const searchBy = document.getElementById('searchBy');
    const fieldFormNumber = document.getElementById('fieldFormNumber');
    const fieldEmail = document.getElementById('fieldEmail');
    const fieldPhone = document.getElementById('fieldPhone');
    const matches = document.getElementById('matches');
    const matchSelect = document.getElementById('matchSelect');
    const inputForm = fieldFormNumber.querySelector('input');
    const inputEmail = fieldEmail.querySelector('input');
    const inputPhone = fieldPhone.querySelector('input');
    const debugBtn = document.getElementById('debugBtn');
    const debugPanel = document.getElementById('debugPanel');
    const clearDebug = document.getElementById('clearDebug');

    let currentRecord = null;
    let currentMatches = [];
    let db = null;

    // Initialize Firebase
    async function initializeFirebase() {
      try {
        addDebugLog('Initializing Firebase...', 'info');
        
        const ok = await window.loadFirebaseConfig();
        if (!ok) {
          throw new Error('Firebase configuration failed to load');
        }
        
        const cfg = {
          apiKey: window.FIREBASE_API_KEY,
          authDomain: window.FIREBASE_AUTH_DOMAIN,
          projectId: window.FIREBASE_PROJECT_ID,
          storageBucket: window.FIREBASE_STORAGE_BUCKET,
          messagingSenderId: window.FIREBASE_MESSAGING_SENDER_ID,
          appId: window.FIREBASE_APP_ID,
        };
        
        addDebugLog('Firebase config validated', 'success');
        const app = initializeApp(cfg);
        db = getFirestore(app);
        addDebugLog('Firebase Firestore initialized successfully', 'success');
        
        return true;
      } catch (error) {
        addDebugLog(`Firebase initialization failed: ${error.message}`, 'error');
        showToast('Firebase initialization failed: ' + error.message, 'error');
        return false;
      }
    }

    // Debug connection test
    async function debugFirebaseConnection() {
      addDebugLog('Testing Firebase connection...', 'info');
      
      if (!db) {
        addDebugLog('Firebase not initialized', 'error');
        showToast('Firebase not initialized', 'error');
        return;
      }
      
      try {
        // Test with a sample document
        const testDocId = '000001';
        addDebugLog(`Testing document: records/${testDocId}`, 'info');
        
        const snap = await getDoc(doc(db, 'records', testDocId));
        
        if (snap.exists()) {
          const data = snap.data();
          addDebugLog(`✓ Document exists with data: ${JSON.stringify(data).substring(0, 100)}...`, 'success');
          addDebugLog(`Available fields: ${Object.keys(data).join(', ')}`, 'info');
        } else {
          addDebugLog('✗ Document does not exist', 'error');
          addDebugLog('Please check if the document exists in Firestore', 'info');
        }
        
        // Test collection query
        addDebugLog('Testing collection query...', 'info');
        const q = query(collection(db, 'records'));
        const querySnap = await getDocs(q);
        addDebugLog(`Total documents in collection: ${querySnap.docs.length}`, 'info');
        
        if (querySnap.docs.length > 0) {
          querySnap.docs.slice(0, 3).forEach((doc, index) => {
            addDebugLog(`Sample doc ${index + 1}: ${doc.id}`, 'info');
          });
        }
        
      } catch (error) {
        addDebugLog(`Connection test failed: ${error.message}`, 'error');
      }
    }

    // Form input management
    function updateInputs() {
      const mode = searchBy.value;
      addDebugLog(`Search mode changed to: ${mode}`, 'info');
      
      // Reset all fields
      fieldFormNumber.classList.add('hidden');
      fieldEmail.classList.add('hidden');
      fieldPhone.classList.add('hidden');
      
      // Show only the selected field
      if (mode === 'form_number') {
        fieldFormNumber.classList.remove('hidden');
        inputForm.required = true;
        inputEmail.required = false;
        inputPhone.required = false;
      } else if (mode === 'email') {
        fieldEmail.classList.remove('hidden');
        inputForm.required = false;
        inputEmail.required = true;
        inputPhone.required = false;
      } else if (mode === 'phone') {
        fieldPhone.classList.remove('hidden');
        inputForm.required = false;
        inputEmail.required = false;
        inputPhone.required = true;
      }
      
      // Hide results when changing search type
      matches.classList.add('hidden');
      result.classList.add('hidden');
      kvPanel.innerHTML = '';
    }

    // Form submission handler
    async function handleFormSubmit(e) {
      e.preventDefault();
      
      const mode = searchBy.value;
      let queryValue = '';
      
      // Get the appropriate input value based on search type
      if (mode === 'form_number') {
        queryValue = inputForm.value.trim();
        if (!queryValue) {
          showToast('Please enter a form number.', 'error');
          return;
        }
      } else if (mode === 'email') {
        queryValue = inputEmail.value.trim();
        if (!queryValue) {
          showToast('Please enter an email address.', 'error');
          return;
        }
      } else if (mode === 'phone') {
        queryValue = inputPhone.value.trim();
        if (!queryValue) {
          showToast('Please enter a phone number.', 'error');
          return;
        }
      }
      
      addDebugLog(`Searching by ${mode} for: "${queryValue}"`, 'info');
      
      try {
        if (!db) {
          throw new Error('Database not initialized');
        }
        
        if (mode === 'form_number') {
          // Pad with zeros to ensure 6-digit format
          const id = String(queryValue).padStart(6, '0');
          addDebugLog(`Looking up document ID: ${id}`, 'info');
          
          const snap = await getDoc(doc(db, 'records', id));
          addDebugLog(`Document exists: ${snap.exists()}`, 'info');
          
          if (!snap.exists()) {
            showToast('No record found for that form number.', 'error');
            addDebugLog('No document found with that ID', 'error');
            return;
          }
          
          currentRecord = { id, ...snap.data() };
          addDebugLog(`Found record: ${JSON.stringify(currentRecord).substring(0, 150)}...`, 'success');
          showRecord(currentRecord);
          
        } else if (mode === 'email') {
          addDebugLog('Querying by email...', 'info');
          const qy = query(collection(db, 'records'), where('email', '==', queryValue));
          const snaps = await getDocs(qy);
          addDebugLog(`Found ${snaps.docs.length} matches for email`, 'info');
          handleMatches(snaps);
          
        } else if (mode === 'phone') {
          addDebugLog('Querying by phone...', 'info');
          const qy = query(collection(db, 'records'), where('phone', '==', queryValue));
          const snaps = await getDocs(qy);
          addDebugLog(`Found ${snaps.docs.length} matches for phone`, 'info');
          handleMatches(snaps);
        }
      } catch (err) {
        addDebugLog(`Search error: ${err.message}`, 'error');
        showToast('Failed to search records: ' + err.message, 'error');
      }
    }

    function handleMatches(snaps) {
      currentMatches = snaps.docs.map(d => ({ id: d.id, ...d.data() }));
      addDebugLog(`Processing ${currentMatches.length} matches`, 'info');
      
      if (!currentMatches.length) {
        matches.classList.add('hidden');
        result.classList.add('hidden');
        showToast('No matching records found.', 'error');
        return;
      }
      
      if (currentMatches.length === 1) {
        // If only one match, show it directly
        currentRecord = currentMatches[0];
        addDebugLog(`Single match found: ${currentRecord.id}`, 'success');
        showRecord(currentRecord);
        matches.classList.add('hidden');
        return;
      }
      
      // Multiple matches - show selection dropdown
      matchSelect.innerHTML = currentMatches.map(r => 
        `<option value="${r.id}">${r.id} - ${escapeHtml(r.full_name || 'Unnamed')}</option>`
      ).join('');
      
      matches.classList.remove('hidden');
      result.classList.add('hidden');
      addDebugLog(`Showing ${currentMatches.length} matches in dropdown`, 'success');
    }

    function showRecord(r) {
      addDebugLog(`Displaying record: ${r.id}`, 'info');
      result.classList.remove('hidden');
      
      const entries = [
        ['Form #', r.form_number || r.id],
        ['Full Name', r.full_name],
        ["Father's Name", r.father_name],
        ["Mother's Name", r.mother_name],
        ['Gender', r.gender],
        ['Date of Birth', r.dob],
        ['Institute', r.institute],
        ['Class', r.class],
        ['Section', r.section],
        ['Phone', r.phone],
        ['Email', r.email],
        ['Address', r.address],
        ['Landmark', r.landmark],
        ['City', r.city],
        ['Category', r.category]
      ];
      
      kvPanel.innerHTML = entries.map(([k, v]) => `
        <div class="k">${escapeHtml(k)}</div>
        <div>${escapeHtml(v || 'Not provided')}</div>
      `).join('');
      
      addDebugLog('Record displayed successfully', 'success');
    }

    function escapeHtml(s = '') { 
      return s.toString().replace(/[&<>\"]/g, c => 
        ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c])
      ); 
    }

    // Event listeners
    function setupEventListeners() {
      searchBy.addEventListener('change', updateInputs);
      form.addEventListener('submit', handleFormSubmit);
      matchSelect.addEventListener('change', handleMatchSelect);
      debugBtn.addEventListener('click', handleDebugClick);
      clearDebug.addEventListener('click', handleClearDebug);
      
      document.getElementById('downloadPdfBtn').addEventListener('click', handleDownloadPdf);
    }

    function handleMatchSelect() {
      const id = matchSelect.value;
      const rec = currentMatches.find(r => r.id === id);
      
      if (rec) {
        currentRecord = rec;
        addDebugLog(`Selected record: ${id}`, 'info');
        showRecord(currentRecord);
      }
    }

    function handleDebugClick() {
      debugPanel.classList.toggle('hidden');
      if (!debugPanel.classList.contains('hidden')) {
        debugFirebaseConnection();
      }
    }

    function handleClearDebug() {
      const debugLogElement = document.getElementById('debugLog');
      if (debugLogElement) {
        debugLogElement.innerHTML = '';
      }
      window.debugLog = [];
    }

    function handleDownloadPdf() {
      if (!currentRecord) {
        showToast('No record to download.', 'error');
        return;
      }
      
      addDebugLog('Generating PDF...', 'info');
      
      const r = currentRecord;
      const doc = new jsPDF();
      let y = 14;
      
      // Header
      doc.setFontSize(16);
      doc.text('SJR MUN Registration', 14, y);
      y += 8;
      
      doc.setFontSize(12);
      doc.text(`Form # ${r.form_number || r.id}`, 14, y);
      y += 8;
      
      // Divider line
      doc.setDrawColor(200);
      doc.line(14, y, 196, y);
      y += 6;
      
      // Form details
      doc.setFontSize(11);
      const pairs = [
        ['Full Name', r.full_name],
        ["Father's Name", r.father_name],
        ["Mother's Name", r.mother_name],
        ['Gender', r.gender],
        ['Date of Birth', r.dob],
        ['Institute', r.institute],
        ['Class', r.class],
        ['Section', r.section],
        ['Phone', r.phone],
        ['Email', r.email],
        ['Address', r.address],
        ['Landmark', r.landmark],
        ['City', r.city],
        ['Category', r.category]
      ];
      
      for (const [k, v] of pairs) {
        const text = `${k}: ${v || 'Not provided'}`;
        const lines = doc.splitTextToSize(text, 182);
        doc.text(lines, 14, y);
        y += 6 + (lines.length - 1) * 5;
        
        // Add new page if we're running out of space
        if (y > 280) {
          doc.addPage();
          y = 14;
        }
      }
      
      // Save the PDF
      const filename = `sjr_mun_form_${r.form_number || r.id}.pdf`;
      doc.save(filename);
      addDebugLog(`PDF downloaded: ${filename}`, 'success');
      showToast('PDF downloaded successfully!', 'success');
    }

    // Initialize the application
    async function init() {
      addDebugLog('Initializing application...', 'info');
      
      // Initialize form state
      updateInputs();
      setupEventListeners();
      
      // Initialize Firebase
      const firebaseReady = await initializeFirebase();
      if (firebaseReady) {
        addDebugLog('Application ready', 'success');
        showToast('Application loaded successfully!', 'success');
      } else {
        addDebugLog('Application initialization failed', 'error');
      }
    }

    // Start the application
    init();
  </script>
</body>
</html>